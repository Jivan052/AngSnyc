<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AngSync Cinema</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * { 
      scrollbar-width: thin; 
      scrollbar-color: #333 #0a0a0a; 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    *::-webkit-scrollbar { width: 6px; height: 6px; }
    *::-webkit-scrollbar-track { background: #0a0a0a; }
    *::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    *::-webkit-scrollbar-thumb:hover { background: #444; }
    
    body { 
      background: #000;
      color: #fff;
      overflow: hidden;
    }
    
    /* Cinema lighting effects */
    .cinema-glow {
      box-shadow: 
        0 0 40px rgba(255,255,255,0.03),
        inset 0 1px 1px rgba(255,255,255,0.05);
    }
    
    .spotlight {
      background: linear-gradient(180deg, 
        rgba(20,20,20,0.95) 0%, 
        rgba(10,10,10,0.98) 50%,
        rgba(0,0,0,1) 100%
      );
    }
    
    /* Video result cards */
    .video-result { 
      background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
      border: 1px solid #222;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .video-result::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);
      transition: left 0.5s;
    }
    
    .video-result:hover::before {
      left: 100%;
    }
    
    .video-result:hover { 
      border-color: #fff;
      transform: translateX(4px) scale(1.02);
      box-shadow: 
        0 0 30px rgba(255,255,255,0.1),
        0 8px 32px rgba(0,0,0,0.6);
    }
    
    .video-result.playing { 
      border-color: #fff;
      background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
      box-shadow: 
        0 0 40px rgba(255,255,255,0.15),
        inset 0 0 20px rgba(255,255,255,0.05);
    }
    
    .video-result.playing::after {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: #fff;
      box-shadow: 0 0 10px #fff;
    }
    
    /* Chat messages */
    .chat-message { 
      animation: messageSlide 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      opacity: 0;
      animation-fill-mode: forwards;
    }
    
    @keyframes messageSlide { 
      from { opacity: 0; transform: translateY(20px) scale(0.9); } 
      to { opacity: 1; transform: translateY(0) scale(1); } 
    }
    
    .my-message { 
      background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
      border: 1px solid #404040;
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
    }
    
    .other-message { 
      background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
      border: 1px solid #2a2a2a;
      box-shadow: 0 2px 12px rgba(0,0,0,0.3);
    }
    
    /* Premium inputs */
    .cinema-input {
      background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
      border: 1px solid #2a2a2a;
      color: #fff;
      transition: all 0.3s ease;
      font-size: 14px;
      letter-spacing: 0.3px;
    }
    
    .cinema-input:focus {
      background: #1a1a1a;
      border-color: #fff;
      outline: none;
      box-shadow: 
        0 0 0 3px rgba(255,255,255,0.05),
        0 0 20px rgba(255,255,255,0.1);
    }
    
    .cinema-input::placeholder {
      color: #666;
      font-weight: 300;
    }
    
    /* Premium buttons */
    .cinema-btn {
      background: linear-gradient(135deg, #fff 0%, #e8e8e8 100%);
      color: #000;
      font-weight: 600;
      font-size: 11px;
      letter-spacing: 1.2px;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      border: none;
      text-transform: uppercase;
      box-shadow: 
        0 2px 8px rgba(255,255,255,0.15),
        inset 0 1px 0 rgba(255,255,255,0.4);
    }
    
    .cinema-btn:hover {
      transform: translateY(-1px);
      box-shadow: 
        0 4px 16px rgba(255,255,255,0.25),
        inset 0 1px 0 rgba(255,255,255,0.5);
      background: linear-gradient(135deg, #fff 0%, #f5f5f5 100%);
    }
    
    .cinema-btn:active {
      transform: translateY(0);
      box-shadow: 
        0 1px 4px rgba(255,255,255,0.1),
        inset 0 1px 0 rgba(255,255,255,0.3);
    }
    
    .cinema-btn-secondary {
      background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
      color: #fff;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 1px;
      border: 1px solid #404040;
      text-transform: uppercase;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 
        0 2px 8px rgba(0,0,0,0.3),
        inset 0 1px 0 rgba(255,255,255,0.05);
    }
    
    .cinema-btn-secondary:hover {
      background: linear-gradient(135deg, #333 0%, #222 100%);
      border-color: #555;
      transform: translateY(-1px);
      box-shadow: 
        0 4px 12px rgba(0,0,0,0.4),
        inset 0 1px 0 rgba(255,255,255,0.08);
    }
    
    .cinema-btn-secondary:active {
      transform: translateY(0);
    }
    
    /* Status badges */
    .status-badge {
      background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
      border: 1px solid #2a2a2a;
      padding: 8px 20px;
      border-radius: 24px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .status-connected {
      background: linear-gradient(135deg, #1a3a1a 0%, #0f1f0f 100%);
      border-color: #2a4a2a;
      color: #7fff7f;
      box-shadow: 0 0 20px rgba(127,255,127,0.1);
    }
    
    .status-connecting {
      background: linear-gradient(135deg, #3a3a1a 0%, #1f1f0f 100%);
      border-color: #4a4a2a;
      color: #ffff7f;
      box-shadow: 0 0 20px rgba(255,255,127,0.1);
    }
    
    .status-error {
      background: linear-gradient(135deg, #3a1a1a 0%, #1f0f0f 100%);
      border-color: #4a2a2a;
      color: #ff7f7f;
      box-shadow: 0 0 20px rgba(255,127,127,0.1);
    }
    
    /* Theater screen effect */
    #player {
      box-shadow: 
        0 0 100px rgba(255,255,255,0.05),
        0 20px 80px rgba(0,0,0,0.8);
    }
    
    .screen-frame {
      background: linear-gradient(180deg, #0a0a0a 0%, #000 50%, #0a0a0a 100%);
      box-shadow: inset 0 0 100px rgba(0,0,0,0.8);
    }
    
    /* Premium dividers */
    .divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, #2a2a2a, transparent);
    }
    
    /* Smooth animations */
    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Resizable panels */
    .resizable {
      position: relative;
    }
    
    .resize-handle {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 4px;
      cursor: ew-resize;
      background: transparent;
      transition: background 0.2s;
      z-index: 10;
    }
    
    .resize-handle:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .resize-handle:active {
      background: rgba(255,255,255,0.2);
    }
    
    .resize-handle-left {
      left: 0;
    }
    
    .resize-handle-right {
      right: 0;
    }
    
    /* Emoji picker */
    .emoji-picker {
      position: absolute;
      bottom: 100%;
      left: 0;
      background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 8px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.6);
      display: none;
      z-index: 100;
      max-width: 280px;
    }
    
    .emoji-picker.show {
      display: block;
      animation: emojiSlideUp 0.2s ease-out;
    }
    
    @keyframes emojiSlideUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .emoji-btn {
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .emoji-btn:hover {
      background: rgba(255,255,255,0.1);
      transform: scale(1.2);
    }
    
    /* Reply feature */
    .reply-banner {
      background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      padding: 8px 12px;
      margin-bottom: 8px;
      display: none;
      align-items: center;
      gap: 8px;
    }
    
    .reply-banner.show {
      display: flex;
    }
    
    .reply-close {
      background: transparent;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 16px;
      padding: 0;
      margin-left: auto;
      transition: color 0.2s;
    }
    
    .reply-close:hover {
      color: #fff;
    }
    
    .reply-indicator {
      border-left: 3px solid #666;
      padding-left: 8px;
      margin-bottom: 8px;
      font-size: 11px;
      color: #999;
      font-style: italic;
    }
    
    .chat-message:hover .reply-btn {
      opacity: 1;
    }
    
    .reply-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255,255,255,0.1);
      border: none;
      color: #fff;
      cursor: pointer;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 4px;
      opacity: 0;
      transition: all 0.2s;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    .reply-btn:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .edit-btn {
      position: absolute;
      top: 8px;
      right: 60px;
      background: rgba(255,255,255,0.1);
      border: none;
      color: #fff;
      cursor: pointer;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 4px;
      opacity: 0;
      transition: all 0.2s;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    .edit-btn:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .chat-message:hover .edit-btn {
      opacity: 1;
    }
    
    .edited-indicator {
      font-size: 10px;
      color: #666;
      font-style: italic;
      margin-top: 4px;
    }
    
    .edit-banner {
      background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      padding: 8px 12px;
      margin-bottom: 8px;
      display: none;
      align-items: center;
      gap: 8px;
    }
    
    .edit-banner.show {
      display: flex;
    }
  </style>
</head>
<body>
  <div class="flex h-screen">
    <!-- Left Sidebar: Video Search -->
    <div id="leftPanel" class="w-80 spotlight border-r border-gray-900 flex flex-col resizable" style="min-width: 250px; max-width: 500px;">
      <div class="resize-handle resize-handle-right"></div>
      <div class="p-6 border-b border-gray-900">
        <h2 class="text-xs font-bold text-gray-400 tracking-widest mb-4 uppercase">Video Library</h2>
        <input id="searchInput" type="text" placeholder="Search videos..." 
          class="w-full px-4 py-3 rounded-lg cinema-input mb-3">
        <button onclick="searchVideos()" class="w-full py-2.5 cinema-btn rounded-lg">
          Search
        </button>
      </div>
      <div id="searchResults" class="flex-1 overflow-y-auto px-4 py-4 space-y-3">
        <div class="text-center py-16 text-gray-600">
          <div class="text-6xl mb-4 opacity-20">üé¨</div>
          <p class="text-sm font-light tracking-wide">Search for content</p>
        </div>
      </div>
    </div>

    <!-- Center: Cinema Screen -->
    <div class="flex-1 flex flex-col screen-frame">
      <div class="px-8 py-6 border-b border-gray-900 spotlight">
        <div class="flex items-center justify-between mb-6 fade-in">
          <div>
            <h1 class="text-2xl font-light text-white tracking-tight mb-1">AngSync Cinema</h1>
            <p class="text-xs text-gray-500 font-light tracking-wide">SYNCHRONIZED VIEWING EXPERIENCE</p>
          </div>
          <div id="connectionStatus" class="status-badge">
            Offline
          </div>
        </div>
        
        <div class="flex gap-4">
          <input id="roomId" type="text" placeholder="Room ID" 
            class="flex-1 px-5 py-4 rounded-lg cinema-input">
          <input id="username" type="text" placeholder="Your Name" 
            class="flex-1 px-5 py-4 rounded-lg cinema-input">
          <button onclick="joinRoom()" class="px-8 py-4 cinema-btn rounded-lg">
            Enter
          </button>
        </div>
      </div>
      
      <div class="flex-1 flex items-center justify-center p-10">
        <div class="w-full h-full relative max-w-7xl mx-auto">
          <div id="player" class="w-full h-full bg-black"></div>
          <div id="noVideo" class="absolute inset-0 flex items-center justify-center bg-black">
            <div class="text-center">
              <div class="w-32 h-32 mx-auto mb-8 rounded-full border-2 border-gray-900 flex items-center justify-center cinema-glow">
                <div class="text-6xl opacity-20">‚ñ∂</div>
              </div>
              <h3 class="text-xl font-light text-white mb-2 tracking-wide">No Content Selected</h3>
              <p class="text-gray-600 text-sm font-light">Browse and select a video to begin</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Sidebar: Chat -->
    <div id="rightPanel" class="w-80 spotlight border-l border-gray-900 flex flex-col resizable" style="min-width: 250px; max-width: 500px;">
      <div class="resize-handle resize-handle-left"></div>
      <div class="p-6 border-b border-gray-900">
        <h2 class="text-xs font-bold text-gray-400 tracking-widest uppercase">Live Discussion</h2>
      </div>
      <div id="chatMessages" class="flex-1 overflow-y-auto px-4 py-4 space-y-4">
        <div class="text-center text-gray-600 py-16">
          <div class="text-6xl mb-4 opacity-20">üí¨</div>
          <p class="text-sm font-light tracking-wide">Join a room to chat</p>
        </div>
      </div>
      <div class="p-4 border-t border-gray-900">
        <div id="editBanner" class="edit-banner">
          <span class="text-xs text-gray-400">Editing message</span>
          <button onclick="cancelEdit()" class="reply-close" title="Cancel edit">‚úï</button>
        </div>
        <div id="replyBanner" class="reply-banner">
          <span class="text-xs text-gray-400">Replying to</span>
          <span id="replyToUser" class="text-xs font-semibold text-white"></span>
          <button onclick="cancelReply()" class="reply-close" title="Cancel reply">‚úï</button>
        </div>
        <div class="flex gap-2 relative">
          <div class="relative flex-1">
            <div id="emojiPicker" class="emoji-picker">
              <div class="emoji-grid" id="emojiGrid"></div>
            </div>
            <input id="chatInput" type="text" placeholder="Message..." 
              class="w-full px-4 py-3 rounded-lg cinema-input text-sm" 
              onkeypress="if(event.key==='Enter') sendMessage()">
          </div>
          <button onclick="toggleEmojiPicker()" class="px-4 py-3 cinema-btn-secondary rounded-lg text-base" title="Add emoji">
            üòÄ
          </button>
          <button onclick="sendMessage()" class="px-4 py-3 cinema-btn-secondary rounded-lg text-base">
            ‚ûú
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    let ws;
    let player;
    let roomId;
    let username;
    let currentVideoUrl = null;
    let isSeeking = false;
    let isPaused = false;
    let isPlaying = false;
    let replyToMessage = null;
    let editingMessage = null;
    const messageMap = new Map();

    // YouTube Search
    async function searchVideos() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return;

      const resultsDiv = document.getElementById('searchResults');
      resultsDiv.innerHTML = '<div class="text-center py-4 text-blue-400">üîç Searching...</div>';

      try {
        const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
        const videos = await response.json();
        
        if (videos.length === 0) {
          resultsDiv.innerHTML = '<div class="text-center py-4 text-gray-400">No videos found</div>';
          return;
        }

        resultsDiv.innerHTML = '';
        videos.forEach(video => {
          const div = document.createElement('div');
          div.className = 'video-result p-4 rounded-xl cursor-pointer';
          div.innerHTML = `
            <div class="flex gap-4">
              <img src="${video.thumbnail}" class="w-24 h-16 rounded-lg object-cover flex-shrink-0 border border-gray-800">
              <div class="flex-1 min-w-0">
                <h4 class="font-medium text-sm text-white mb-2 line-clamp-2 leading-snug">${video.title}</h4>
                <p class="text-xs text-gray-500 mb-1 font-light">${video.author}</p>
                <p class="text-xs text-gray-600 font-mono">${video.duration}</p>
              </div>
            </div>
          `;
          div.onclick = () => selectVideo(video.url, div);
          resultsDiv.appendChild(div);
        });
      } catch (error) {
        resultsDiv.innerHTML = '<div class="text-center py-8 text-gray-600 text-sm font-light">Search failed. Try again.</div>';
      }
    }

    function selectVideo(url, element) {
      document.querySelectorAll('.video-result').forEach(el => el.classList.remove('playing'));
      element.classList.add('playing');
      
      currentVideoUrl = url;
      console.log('üé¨ Selected video:', url);
      console.log('WebSocket state:', ws ? ws.readyState : 'null', 'Room ID:', roomId);
      
      loadVideo(url);
      
      // Send to room if connected
      if (!roomId) {
        console.warn('‚ö†Ô∏è No room joined yet. Video will be broadcast when you join a room.');
        return;
      }
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        const message = { roomId, action: 'changeUrl', url };
        console.log('üì§ Sending changeUrl to room:', message);
        ws.send(JSON.stringify(message));
      } else {
        console.warn('‚ö†Ô∏è WebSocket not ready - ws:', !!ws, 'state:', ws?.readyState, 'Room:', roomId);
        console.log('Video will be broadcast when connection is established');
      }
    }

    function joinRoom() {
      const enteredRoomId = document.getElementById('roomId').value.trim();
      const enteredUsername = document.getElementById('username').value.trim();
      
      if (!enteredRoomId) {
        alert("Please enter a Room ID");
        return;
      }
      
      if (!enteredUsername) {
        alert("Please enter your name");
        return;
      }

      // If already connected to the same room, don't reconnect
      if (ws && ws.readyState === WebSocket.OPEN && roomId === enteredRoomId) {
        console.log('‚ö†Ô∏è Already connected to room', roomId);
        return;
      }

      // Close existing connection if any
      if (ws) {
        ws.onclose = null; // Prevent onclose handler from triggering
        ws.close();
      }

      roomId = enteredRoomId;
      username = enteredUsername;
      
      // Update status
      const statusDiv = document.getElementById('connectionStatus');
      statusDiv.textContent = 'Connecting';
      statusDiv.className = 'status-badge status-connecting';

      ws = new WebSocket('wss://angsnyc-3.onrender.com');

      ws.onopen = () => {
        console.log('‚úÖ WebSocket connected');
        statusDiv.textContent = `Room ${roomId}`;
        statusDiv.className = 'status-badge status-connected';
        ws.send(JSON.stringify({ roomId, username, action: 'join' }));
        
        // Clear chat messages
        document.getElementById('chatMessages').innerHTML = '';
        
        // If a video was already selected before joining, broadcast it to the room
        if (currentVideoUrl) {
          console.log('üì§ Broadcasting previously selected video:', currentVideoUrl);
          setTimeout(() => {
            ws.send(JSON.stringify({ roomId, action: 'changeUrl', url: currentVideoUrl }));
          }, 100);
        }
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log('üì© Received:', data.type, data.time);

        switch (data.type) {
          case 'userCount':
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.textContent = `${data.count} Online ‚Ä¢ Room ${roomId}`;
            statusDiv.className = 'status-badge status-connected';
            break;
          case 'sync':
          case 'changeUrl':
            console.log('üì∫ Received sync/changeUrl - URL:', data.url, 'Time:', data.time);
            if (data.url) {
              currentVideoUrl = data.url;
              console.log('üì∫ Loading video:', data.url);
              loadVideo(data.url);
              if (data.time > 0) {
                setTimeout(() => {
                  if (player) player.seekTo(data.time, true);
                }, 1000);
              }
            } else {
              console.log('‚ÑπÔ∏è No video in room yet');
            }
            break;
          case 'play':
            if (player && !isPlaying) {
              isSeeking = true;
              isPlaying = true;
              isPaused = false;
              player.seekTo(data.time, true);
              player.playVideo();
              setTimeout(() => isSeeking = false, 500);
              console.log('‚ñ∂Ô∏è Playing');
            }
            break;
          case 'pause':
            if (player && !isPaused) {
              isSeeking = true;
              isPaused = true;
              isPlaying = false;
              player.seekTo(data.time, true);
              player.pauseVideo();
              setTimeout(() => isSeeking = false, 500);
              console.log('‚è∏ Paused');
            }
            break;
          case 'seek':
            if (player && !isSeeking) {
              const currentTime = player.getCurrentTime();
              if (Math.abs(currentTime - data.time) > 2) {
                isSeeking = true;
                player.seekTo(data.time, true);
                setTimeout(() => isSeeking = false, 500);
                console.log('‚è© Seeked to', data.time);
              }
            }
            break;
          case 'chat':
            displayChatMessage(data.username, data.message, data.username === username, data.replyTo, data.messageId, false);
            break;
          case 'editChat':
            displayChatMessage(data.username, data.message, data.username === username, data.replyTo, data.messageId, true);
            break;
        }
      };

      ws.onerror = (error) => {
        console.error('‚ùå WebSocket error:', error);
        const statusDiv = document.getElementById('connectionStatus');
        statusDiv.textContent = 'Error';
        statusDiv.className = 'status-badge status-error';
      };
      
      ws.onclose = () => {
        console.log('‚ö†Ô∏è WebSocket disconnected');
        const statusDiv = document.getElementById('connectionStatus');
        statusDiv.textContent = 'Offline';
        statusDiv.className = 'status-badge';
      };
    }

    function loadVideo(url) {
      const videoId = extractVideoId(url);
      if (!videoId) return;

      document.getElementById('noVideo').style.display = 'none';
      
      if (player) {
        player.loadVideoById(videoId);
      }
    }

    function extractVideoId(url) {
      const match = url.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
      return match ? match[1] : null;
    }

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '100%',
        width: '100%',
        playerVars: { 'autoplay': 0, 'controls': 1, 'rel': 0, 'modestbranding': 1 },
        events: {
          'onReady': () => console.log('‚úÖ Player ready'),
          'onStateChange': onPlayerStateChange
        }
      });
    }

    function onPlayerStateChange(event) {
      if (!ws || ws.readyState !== WebSocket.OPEN || isSeeking) return;

      const currentTime = player.getCurrentTime();

      if (event.data === YT.PlayerState.PLAYING) {
        isPlaying = true;
        isPaused = false;
        if (roomId) ws.send(JSON.stringify({ roomId, action: 'play', time: currentTime }));
      } else if (event.data === YT.PlayerState.PAUSED) {
        isPlaying = false;
        isPaused = true;
        if (roomId) ws.send(JSON.stringify({ roomId, action: 'pause', time: currentTime }));
      }
    }

    let lastSyncTime = 0;
    setInterval(() => {
      if (player && ws && ws.readyState === WebSocket.OPEN && roomId && !isSeeking) {
        try {
          if (player.getPlayerState() === YT.PlayerState.PLAYING) {
            const currentTime = player.getCurrentTime();
            if (Math.abs(currentTime - lastSyncTime) > 0.5) {
              lastSyncTime = currentTime;
              ws.send(JSON.stringify({ roomId, action: 'seek', time: currentTime }));
            }
          }
        } catch (e) {}
      }
    }, 1000);

    document.addEventListener('keypress', (e) => {
      if (e.target.id === 'searchInput' && e.key === 'Enter') searchVideos();
      if (e.target.id === 'roomId' && e.key === 'Enter') {
        document.getElementById('username').focus();
      }
      if (e.target.id === 'username' && e.key === 'Enter') joinRoom();
    });

    function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      if (!ws || ws.readyState !== WebSocket.OPEN || !roomId) {
        alert('Please join a room first!');
        return;
      }
      
      if (editingMessage) {
        // Send edit action
        const editData = {
          roomId,
          action: 'editChat',
          messageId: editingMessage.id,
          newMessage: message
        };
        ws.send(JSON.stringify(editData));
        input.value = '';
        cancelEdit();
      } else {
        // Send new message
        const messageId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const messageData = { 
          roomId, 
          action: 'chat', 
          username,
          message,
          messageId
        };
        
        if (replyToMessage) {
          messageData.replyTo = {
            username: replyToMessage.username,
            message: replyToMessage.message
          };
        }
        
        ws.send(JSON.stringify(messageData));
        
        input.value = '';
        cancelReply();
      }
    }
    
    function setReplyTo(sender, message) {
      replyToMessage = { username: sender, message: message };
      document.getElementById('replyToUser').textContent = sender;
      document.getElementById('replyBanner').classList.add('show');
      document.getElementById('chatInput').focus();
    }
    
    function cancelReply() {
      replyToMessage = null;
      document.getElementById('replyBanner').classList.remove('show');
    }
    
    function editMessage(messageId, currentMessage) {
      editingMessage = { id: messageId, message: currentMessage };
      document.getElementById('editBanner').classList.add('show');
      const input = document.getElementById('chatInput');
      input.value = currentMessage;
      input.focus();
      
      // Cancel reply if active
      cancelReply();
    }
    
    function cancelEdit() {
      editingMessage = null;
      document.getElementById('editBanner').classList.remove('show');
      document.getElementById('chatInput').value = '';
    }

    function displayChatMessage(sender, message, isMe, replyTo, messageId, isEdited) {
      const chatDiv = document.getElementById('chatMessages');
      
      // Check if message already exists (for edits)
      let msgDiv = messageId ? messageMap.get(messageId) : null;
      const isUpdate = !!msgDiv;
      
      if (!msgDiv) {
        msgDiv = document.createElement('div');
        msgDiv.className = 'chat-message';
        msgDiv.style.position = 'relative';
        if (messageId) {
          msgDiv.setAttribute('data-message-id', messageId);
          messageMap.set(messageId, msgDiv);
        }
      }
      
      const bubbleClass = isMe ? 'my-message' : 'other-message';
      
      let replyHtml = '';
      if (replyTo) {
        replyHtml = `
          <div class="reply-indicator">
            <div class="font-semibold">${escapeHtml(replyTo.username)}</div>
            <div class="truncate">${escapeHtml(replyTo.message.substring(0, 50))}${replyTo.message.length > 50 ? '...' : ''}</div>
          </div>
        `;
      }
      
      const editedHtml = isEdited ? '<div class="edited-indicator">edited</div>' : '';
      const editBtnHtml = isMe && messageId ? `<button class="edit-btn" onclick='editMessage("${messageId}", "${message.replace(/"/g, '&quot;').replace(/'/g, "&apos;")}")'>Edit</button>` : '';
      
      msgDiv.innerHTML = `
        <div class="${bubbleClass} rounded-2xl px-5 py-3 max-w-xs ${isMe ? 'ml-auto' : 'mr-auto'}" style="position: relative;">
          ${editBtnHtml}
          <button class="reply-btn" onclick='setReplyTo("${sender.replace(/"/g, '&quot;')}", "${message.replace(/"/g, '&quot;').replace(/'/g, "&apos;")}")'>Reply</button>
          <div class="text-xs font-semibold mb-2 ${isMe ? 'text-gray-300' : 'text-gray-500'} tracking-wide uppercase">${sender}</div>
          ${replyHtml}
          <div class="text-sm text-white leading-relaxed font-light">${escapeHtml(message)}</div>
          ${editedHtml}
        </div>
      `;
      
      if (!isUpdate) {
        chatDiv.appendChild(msgDiv);
        chatDiv.scrollTop = chatDiv.scrollHeight;
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Resizable panels
    function initResizablePanels() {
      const leftPanel = document.getElementById('leftPanel');
      const rightPanel = document.getElementById('rightPanel');
      
      const leftHandle = leftPanel.querySelector('.resize-handle-right');
      const rightHandle = rightPanel.querySelector('.resize-handle-left');
      
      let isResizing = false;
      let currentPanel = null;
      
      function startResize(panel, e) {
        isResizing = true;
        currentPanel = panel;
        document.body.style.cursor = 'ew-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      }
      
      function resize(e) {
        if (!isResizing || !currentPanel) return;
        
        const rect = currentPanel.getBoundingClientRect();
        let newWidth;
        
        if (currentPanel === leftPanel) {
          newWidth = e.clientX - rect.left;
        } else {
          newWidth = rect.right - e.clientX;
        }
        
        const minWidth = parseInt(currentPanel.style.minWidth) || 250;
        const maxWidth = parseInt(currentPanel.style.maxWidth) || 500;
        
        newWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
        currentPanel.style.width = newWidth + 'px';
      }
      
      function stopResize() {
        isResizing = false;
        currentPanel = null;
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
      }
      
      leftHandle.addEventListener('mousedown', (e) => startResize(leftPanel, e));
      rightHandle.addEventListener('mousedown', (e) => startResize(rightPanel, e));
      
      document.addEventListener('mousemove', resize);
      document.addEventListener('mouseup', stopResize);
    }
    
    // Initialize resizable panels on load
    initResizablePanels();

    // Emoji Picker
    const emojis = [
      'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòÇ',
      'üôÇ', 'üôÉ', 'üòâ', 'üòä', 'üòá', 'ü•∞', 'üòç', 'ü§©',
      'üòò', 'üòó', 'üòö', 'üòô', 'üòã', 'üòõ', 'üòú', 'ü§™',
      'üòù', 'ü§ë', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î', 'ü§ê', 'ü§®',
      'üòê', 'üòë', 'üò∂', 'üòè', 'üòí', 'üôÑ', 'üò¨', 'ü§•',
      'üòå', 'üòî', 'üò™', 'ü§§', 'üò¥', 'üò∑', 'ü§í', 'ü§ï',
      'ü§¢', 'ü§Æ', 'ü§ß', 'ü•µ', 'ü•∂', 'üòµ', 'ü§Ø', 'ü§†',
      'ü•≥', 'üòé', 'ü§ì', 'üßê', 'üòï', 'üòü', 'üôÅ', 'üòÆ',
      'üòØ', 'üò≤', 'üò≥', 'ü•∫', 'üò¶', 'üòß', 'üò®', 'üò∞',
      'üò•', 'üò¢', 'üò≠', 'üò±', 'üòñ', 'üò£', 'üòû', 'üòì',
      'üò©', 'üò´', 'ü•±', 'üò§', 'üò°', 'üò†', 'ü§¨', 'üëç',
      'üëé', 'üëå', '‚úåÔ∏è', 'ü§û', 'ü§ü', 'ü§ò', 'ü§ô', 'üëà',
      'üëâ', 'üëÜ', 'üëá', '‚òùÔ∏è', 'üëã', 'ü§ö', 'üñêÔ∏è', '‚úã',
      'üññ', 'üëè', 'üôå', 'üëê', 'ü§≤', 'ü§ù', 'üôè', '‚úçÔ∏è',
      'üí™', 'ü¶æ', 'ü¶ø', 'ü¶µ', 'ü¶∂', 'üëÇ', 'ü¶ª', 'üëÉ',
      '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç',
      'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ',
      'üíò', 'üíù', 'üíü', '‚òÆÔ∏è', '‚úùÔ∏è', '‚ò™Ô∏è', 'üïâÔ∏è', '‚ò∏Ô∏è',
      '‚ú°Ô∏è', 'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê', '‚õé', '‚ôà',
      '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê',
      '‚ôë', '‚ôí', '‚ôì', 'üÜî', '‚öõÔ∏è', 'üâë', '‚ò¢Ô∏è', '‚ò£Ô∏è',
      'üî¥', 'üü†', 'üü°', 'üü¢', 'üîµ', 'üü£', '‚ö´', '‚ö™',
      'üü§', 'üî∫', 'üîª', 'üî∏', 'üîπ', 'üî∂', 'üî∑', 'üî≥',
      'üî≤', '‚ñ™Ô∏è', '‚ñ´Ô∏è', '‚óæ', '‚óΩ', '‚óºÔ∏è', '‚óªÔ∏è', 'üü•',
      'üüß', 'üü®', 'üü©', 'üü¶', 'üü™', '‚¨õ', '‚¨ú', 'üü´',
      '‚úÖ', '‚òëÔ∏è', '‚úîÔ∏è', '‚úñÔ∏è', '‚ùå', '‚ùé', '‚ûï', '‚ûñ',
      '‚ûó', '‚û∞', '‚ûø', '„ÄΩÔ∏è', '‚ú≥Ô∏è', '‚ú¥Ô∏è', '‚ùáÔ∏è', '‚ÄºÔ∏è',
      '‚ÅâÔ∏è', '‚ùì', '‚ùî', '‚ùï', '‚ùó', '„Ä∞Ô∏è', '¬©Ô∏è', '¬ÆÔ∏è',
      '‚Ñ¢Ô∏è', '#Ô∏è‚É£', '*Ô∏è‚É£', '0Ô∏è‚É£', '1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£',
      '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£', 'üîü', 'üî†', 'üî°',
      'üî¢', 'üî£', 'üî§', 'üÖ∞Ô∏è', 'üÜé', 'üÖ±Ô∏è', 'üÜë', 'üÜí',
      'üÜì', '‚ÑπÔ∏è', 'üÜî', '‚ìÇÔ∏è', 'üÜï', 'üÜñ', 'üÖæÔ∏è', 'üÜó',
      'üÖøÔ∏è', 'üÜò', 'üÜô', 'üÜö', 'üàÅ', 'üàÇÔ∏è', 'üà∑Ô∏è', 'üà∂',
      'üàØ', 'üâê', 'üàπ', 'üàö', 'üà≤', 'üâë', 'üà∏', 'üà¥',
      'üé¨', 'üé≠', 'üé®', 'üé™', 'üé§', 'üéß', 'üéº', 'üéπ',
      'ü•Å', 'üé∑', 'üé∫', 'üé∏', 'ü™ï', 'üéª', 'üé≤', '‚ôüÔ∏è',
      'üéØ', 'üé≥', 'üéÆ', 'üé∞', 'üß©', 'üöó', 'üöï', 'üöô',
      'üöå', 'üöé', 'üèéÔ∏è', 'üöì', 'üöë', 'üöí', 'üöê', 'üöö',
      'üöõ', 'üöú', 'ü¶Ø', 'ü¶Ω', 'ü¶º', 'üõ¥', 'üö≤', 'üõµ',
      'üèçÔ∏è', 'üõ∫', 'üö®', 'üöî', 'üöç', 'üöò', 'üöñ', 'üö°'
    ];

    function initEmojiPicker() {
      const emojiGrid = document.getElementById('emojiGrid');
      emojis.forEach(emoji => {
        const btn = document.createElement('button');
        btn.className = 'emoji-btn';
        btn.textContent = emoji;
        btn.onclick = () => insertEmoji(emoji);
        emojiGrid.appendChild(btn);
      });
    }

    function toggleEmojiPicker() {
      const picker = document.getElementById('emojiPicker');
      picker.classList.toggle('show');
    }

    function insertEmoji(emoji) {
      const input = document.getElementById('chatInput');
      const start = input.selectionStart;
      const end = input.selectionEnd;
      const text = input.value;
      
      input.value = text.substring(0, start) + emoji + text.substring(end);
      input.focus();
      
      const newPos = start + emoji.length;
      input.setSelectionRange(newPos, newPos);
      
      toggleEmojiPicker();
    }

    // Close emoji picker when clicking outside
    document.addEventListener('click', (e) => {
      const picker = document.getElementById('emojiPicker');
      const emojiBtn = e.target.closest('button[onclick="toggleEmojiPicker()"]');
      
      if (!picker.contains(e.target) && !emojiBtn && picker.classList.contains('show')) {
        picker.classList.remove('show');
      }
    });

    // Initialize emoji picker
    initEmojiPicker();
  </script>
</body>
</html>
