<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AngSync Cinema</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * { 
      scrollbar-width: thin; 
      scrollbar-color: #333 #0a0a0a; 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    *::-webkit-scrollbar { width: 6px; height: 6px; }
    *::-webkit-scrollbar-track { background: #0a0a0a; }
    *::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    *::-webkit-scrollbar-thumb:hover { background: #444; }
    
    body { 
      background: #000;
      color: #fff;
      overflow: hidden;
    }
    
    /* Cinema lighting effects */
    .cinema-glow {
      box-shadow: 
        0 0 40px rgba(255,255,255,0.03),
        inset 0 1px 1px rgba(255,255,255,0.05);
    }
    
    .spotlight {
      background: linear-gradient(180deg, 
        rgba(20,20,20,0.95) 0%, 
        rgba(10,10,10,0.98) 50%,
        rgba(0,0,0,1) 100%
      );
    }
    
    /* Video result cards */
    .video-result { 
      background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
      border: 1px solid #222;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .video-result::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);
      transition: left 0.5s;
    }
    
    .video-result:hover::before {
      left: 100%;
    }
    
    .video-result:hover { 
      border-color: #fff;
      transform: translateX(4px) scale(1.02);
      box-shadow: 
        0 0 30px rgba(255,255,255,0.1),
        0 8px 32px rgba(0,0,0,0.6);
    }
    
    .video-result.playing { 
      border-color: #fff;
      background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
      box-shadow: 
        0 0 40px rgba(255,255,255,0.15),
        inset 0 0 20px rgba(255,255,255,0.05);
    }
    
    .video-result.playing::after {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: #fff;
      box-shadow: 0 0 10px #fff;
    }
    
    /* Chat messages */
    .chat-message { 
      animation: messageSlide 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      opacity: 0;
      animation-fill-mode: forwards;
    }
    
    @keyframes messageSlide { 
      from { opacity: 0; transform: translateY(20px) scale(0.9); } 
      to { opacity: 1; transform: translateY(0) scale(1); } 
    }
    
    .my-message { 
      background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
      border: 1px solid #404040;
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
    }
    
    .other-message { 
      background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
      border: 1px solid #2a2a2a;
      box-shadow: 0 2px 12px rgba(0,0,0,0.3);
    }
    
    /* Premium inputs */
    .cinema-input {
      background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
      border: 1px solid #2a2a2a;
      color: #fff;
      transition: all 0.3s ease;
      font-size: 14px;
      letter-spacing: 0.3px;
    }
    
    .cinema-input:focus {
      background: #1a1a1a;
      border-color: #fff;
      outline: none;
      box-shadow: 
        0 0 0 3px rgba(255,255,255,0.05),
        0 0 20px rgba(255,255,255,0.1);
    }
    
    .cinema-input::placeholder {
      color: #666;
      font-weight: 300;
    }
    
    /* Premium buttons */
    .cinema-btn {
      background: linear-gradient(135deg, #fff 0%, #e8e8e8 100%);
      color: #000;
      font-weight: 600;
      font-size: 11px;
      letter-spacing: 1.2px;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      border: none;
      text-transform: uppercase;
      box-shadow: 
        0 2px 8px rgba(255,255,255,0.15),
        inset 0 1px 0 rgba(255,255,255,0.4);
    }
    
    .cinema-btn:hover {
      transform: translateY(-1px);
      box-shadow: 
        0 4px 16px rgba(255,255,255,0.25),
        inset 0 1px 0 rgba(255,255,255,0.5);
      background: linear-gradient(135deg, #fff 0%, #f5f5f5 100%);
    }
    
    .cinema-btn:active {
      transform: translateY(0);
      box-shadow: 
        0 1px 4px rgba(255,255,255,0.1),
        inset 0 1px 0 rgba(255,255,255,0.3);
    }
    
    .cinema-btn-secondary {
      background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
      color: #fff;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 1px;
      border: 1px solid #404040;
      text-transform: uppercase;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 
        0 2px 8px rgba(0,0,0,0.3),
        inset 0 1px 0 rgba(255,255,255,0.05);
    }
    
    .cinema-btn-secondary:hover {
      background: linear-gradient(135deg, #333 0%, #222 100%);
      border-color: #555;
      transform: translateY(-1px);
      box-shadow: 
        0 4px 12px rgba(0,0,0,0.4),
        inset 0 1px 0 rgba(255,255,255,0.08);
    }
    
    .cinema-btn-secondary:active {
      transform: translateY(0);
    }
    
    /* Status badges */
    .status-badge {
      background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
      border: 1px solid #2a2a2a;
      padding: 8px 20px;
      border-radius: 24px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .status-connected {
      background: linear-gradient(135deg, #1a3a1a 0%, #0f1f0f 100%);
      border-color: #2a4a2a;
      color: #7fff7f;
      box-shadow: 0 0 20px rgba(127,255,127,0.1);
    }
    
    .status-connecting {
      background: linear-gradient(135deg, #3a3a1a 0%, #1f1f0f 100%);
      border-color: #4a4a2a;
      color: #ffff7f;
      box-shadow: 0 0 20px rgba(255,255,127,0.1);
    }
    
    .status-error {
      background: linear-gradient(135deg, #3a1a1a 0%, #1f0f0f 100%);
      border-color: #4a2a2a;
      color: #ff7f7f;
      box-shadow: 0 0 20px rgba(255,127,127,0.1);
    }
    
    /* Theater screen effect */
    #player {
      box-shadow: 
        0 0 100px rgba(255,255,255,0.05),
        0 20px 80px rgba(0,0,0,0.8);
    }
    
    .screen-frame {
      background: linear-gradient(180deg, #0a0a0a 0%, #000 50%, #0a0a0a 100%);
      box-shadow: inset 0 0 100px rgba(0,0,0,0.8);
    }
    
    /* Premium dividers */
    .divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, #2a2a2a, transparent);
    }
    
    /* Smooth animations */
    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Resizable panels */
    .resizable {
      position: relative;
    }
    
    .resize-handle {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 4px;
      cursor: ew-resize;
      background: transparent;
      transition: background 0.2s;
      z-index: 10;
    }
    
    .resize-handle:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .resize-handle:active {
      background: rgba(255,255,255,0.2);
    }
    
    .resize-handle-left {
      left: 0;
    }
    
    .resize-handle-right {
      right: 0;
    }
    
    /* Emoji picker */
    .emoji-picker {
      position: absolute;
      bottom: 100%;
      left: 0;
      background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 8px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.6);
      display: none;
      z-index: 100;
      max-width: 280px;
    }
    
    .emoji-picker.show {
      display: block;
      animation: emojiSlideUp 0.2s ease-out;
    }
    
    @keyframes emojiSlideUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .emoji-btn {
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .emoji-btn:hover {
      background: rgba(255,255,255,0.1);
      transform: scale(1.2);
    }
    
    /* Reply feature */
    .reply-banner {
      background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      padding: 8px 12px;
      margin-bottom: 8px;
      display: none;
      align-items: center;
      gap: 8px;
    }
    
    .reply-banner.show {
      display: flex;
    }
    
    .reply-close {
      background: transparent;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 16px;
      padding: 0;
      margin-left: auto;
      transition: color 0.2s;
    }
    
    .reply-close:hover {
      color: #fff;
    }
    
    .reply-indicator {
      border-left: 3px solid #666;
      padding-left: 8px;
      margin-bottom: 8px;
      font-size: 11px;
      color: #999;
      font-style: italic;
    }
    
    .chat-message:hover .reply-btn {
      opacity: 1;
    }
    
    .reply-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255,255,255,0.1);
      border: none;
      color: #fff;
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      opacity: 0;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
    }
    
    .reply-btn:hover {
      background: rgba(255,255,255,0.2);
      transform: scale(1.1);
    }
    
    .edit-btn {
      position: absolute;
      top: 8px;
      right: 76px;
      background: rgba(255,255,255,0.1);
      border: none;
      color: #fff;
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      opacity: 0;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
    }
    
    .edit-btn:hover {
      background: rgba(255,255,255,0.2);
      transform: scale(1.1);
    }
    
    .chat-message:hover .edit-btn {
      opacity: 1;
    }
    
    .delete-btn {
      position: absolute;
      top: 8px;
      right: 42px;
      background: rgba(255,100,100,0.1);
      border: none;
      color: #ff6464;
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      opacity: 0;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
    }
    
    .delete-btn:hover {
      background: rgba(255,100,100,0.2);
      transform: scale(1.1);
    }
    
    .chat-message:hover .delete-btn {
      opacity: 1;
    }
    
    .edited-indicator {
      font-size: 10px;
      color: #666;
      font-style: italic;
      margin-top: 4px;
    }
    
    .edit-banner {
      background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      padding: 8px 12px;
      margin-bottom: 8px;
      display: none;
      align-items: center;
      gap: 8px;
    }
    
    .edit-banner.show {
      display: flex;
    }
    
    /* Voice recording */
    .voice-btn {
      background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
      color: #fff;
      font-size: 18px;
      border: 1px solid #404040;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .voice-btn:hover {
      background: linear-gradient(135deg, #333 0%, #222 100%);
      border-color: #555;
      transform: translateY(-1px);
    }
    
    .voice-btn.recording {
      background: linear-gradient(135deg, #8b0000 0%, #660000 100%);
      border-color: #ff0000;
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
      50% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.2);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    .recording-timer {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(139, 0, 0, 0.95);
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
      display: none;
      white-space: nowrap;
    }
    
    .recording-timer.show {
      display: block;
    }
    
    .media-preview {
      position: absolute;
      bottom: 100%;
      left: 0;
      right: 0;
      background: rgba(20,20,20,0.98);
      border: 1px solid #333;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 8px;
      display: none;
    }
    
    .media-preview.show {
      display: block;
    }
    
    .media-preview img,
    .media-preview video {
      max-width: 200px;
      max-height: 150px;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    
    .media-preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .media-preview-close {
      background: rgba(255,100,100,0.2);
      border: none;
      color: #ff6464;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
    }
    
    .media-preview-close:hover {
      background: rgba(255,100,100,0.3);
    }
    
    .media-message img,
    .media-message video {
      max-width: 300px;
      width: 100%;
      border-radius: 8px;
      margin-top: 8px;
      cursor: pointer;
    }
    
    .voice-message {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 200px;
    }
    
    .voice-play-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    
    .voice-play-btn:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.5);
    }
    
    .voice-play-btn.playing {
      background: rgba(255,255,255,0.2);
    }
    
    .voice-waveform {
      flex: 1;
      height: 32px;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    
    .voice-bar {
      width: 3px;
      background: rgba(255,255,255,0.3);
      border-radius: 2px;
      transition: all 0.2s;
    }
    
    .voice-duration {
      font-size: 11px;
      color: #999;
      font-weight: 500;
      flex-shrink: 0;
    }
    
    /* Emoji Reactions */
    .reaction-picker {
      position: absolute;
      bottom: -45px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
      border: 1px solid #2a2a2a;
      border-radius: 25px;
      padding: 8px 12px;
      display: none;
      gap: 6px;
      z-index: 200;
      box-shadow: 0 8px 32px rgba(0,0,0,0.8);
    }
    
    .reaction-picker.show {
      display: flex;
      animation: reactionSlideUp 0.2s ease-out;
    }
    
    @keyframes reactionSlideUp {
      from { opacity: 0; transform: translateX(-50%) translateY(10px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    
    .reaction-option {
      background: transparent;
      border: none;
      font-size: 22px;
      cursor: pointer;
      padding: 6px;
      border-radius: 50%;
      transition: all 0.2s;
      line-height: 1;
    }
    
    .reaction-option:hover {
      background: rgba(255,255,255,0.1);
      transform: scale(1.3);
    }
    
    .reactions-container {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 8px;
    }
    
    .reaction-bubble {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 4px 8px;
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .reaction-bubble:hover {
      background: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.2);
      transform: scale(1.05);
    }
    
    .reaction-bubble.my-reaction {
      background: rgba(255,255,255,0.15);
      border-color: rgba(255,255,255,0.3);
    }
    
    .reaction-count {
      font-size: 11px;
      color: #ccc;
      font-weight: 600;
    }
    
    .react-btn {
      position: absolute;
      bottom: -12px;
      right: 12px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      padding: 4px 8px;
      border-radius: 12px;
      opacity: 0;
      transition: all 0.2s;
      line-height: 1;
    }
    
    .react-btn:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.3);
    }
    
    .chat-message:hover .react-btn {
      opacity: 1;
    }
    
    /* Voice Call */
    .call-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .call-btn {
      background: linear-gradient(135deg, #2a7a2a 0%, #1a5a1a 100%);
      color: #fff;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 1px;
      border: 1px solid #3a8a3a;
      text-transform: uppercase;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .call-btn:hover {
      background: linear-gradient(135deg, #3a8a3a 0%, #2a6a2a 100%);
      border-color: #4a9a4a;
      transform: translateY(-1px);
    }
    
    .call-btn.in-call {
      background: linear-gradient(135deg, #8b0000 0%, #660000 100%);
      border-color: #ff0000;
      animation: callPulse 2s ease-in-out infinite;
    }
    
    @keyframes callPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.5); }
      50% { box-shadow: 0 0 0 8px rgba(255, 0, 0, 0); }
    }
    
    .call-status {
      font-size: 10px;
      color: #7fff7f;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      padding: 4px 12px;
      background: rgba(127, 255, 127, 0.1);
      border-radius: 12px;
      border: 1px solid rgba(127, 255, 127, 0.2);
    }
    
    .participants-count {
      font-size: 10px;
      color: #999;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    
    .mute-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    .mute-btn:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.3);
    }
    
    .mute-btn.muted {
      background: rgba(255, 100, 100, 0.2);
      border-color: rgba(255, 100, 100, 0.3);
      color: #ff6464;
    }
    
    /* Video Call */
    .video-grid {
      position: fixed;
      bottom: 80px;
      right: 20px;
      display: none;
      flex-direction: column;
      gap: 12px;
      z-index: 1000;
      background: rgba(10, 10, 10, 0.95);
      border: 2px solid #2a2a2a;
      border-radius: 12px;
      padding: 12px;
      min-width: 200px;
      min-height: 150px;
      max-width: 90vw;
      max-height: 90vh;
      overflow: auto;
      resize: both;
    }
    
    .video-grid.show {
      display: flex;
    }
    
    .video-grid-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(20, 20, 20, 0.8);
      border-radius: 8px;
      margin-bottom: 12px;
      cursor: move;
      user-select: none;
      border: 1px solid #333;
    }
    
    .video-grid-header:hover {
      background: rgba(30, 30, 30, 0.9);
      border-color: #555;
    }
    
    .video-grid-title {
      font-size: 12px;
      font-weight: 600;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .drag-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2'%3E%3Cpath d='M9 5h.01M9 12h.01M9 19h.01M15 5h.01M15 12h.01M15 19h.01'/%3E%3C/svg%3E");
      background-size: contain;
      opacity: 0.6;
    }
    
    .video-grid-content {
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex: 1;
      overflow-y: auto;
    }
    
    .video-container {
      position: relative;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid #2a2a2a;
      box-shadow: 0 4px 16px rgba(0,0,0,0.6);
      width: 100%;
      min-height: 150px;
      transition: all 0.3s;
    }
    
    .video-container:hover {
      border-color: #fff;
    }
    
    .video-container video {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
    }
    
    .video-container.local-video {
      border-color: #3a8a3a;
    }
    
    .video-label {
      position: absolute;
      bottom: 8px;
      left: 8px;
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    
    .video-audio-indicator {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0,0,0,0.8);
      color: #7fff7f;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 11px;
      line-height: 1;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .video-audio-indicator.muted {
      color: #ff6464;
    }
    
    .icon {
      display: inline-block;
      width: 14px;
      height: 14px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }
    
    .icon-mic {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%237fff7f' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z'%3E%3C/path%3E%3Cpath d='M19 10v2a7 7 0 0 1-14 0v-2'%3E%3C/path%3E%3Cline x1='12' y1='19' x2='12' y2='23'%3E%3C/line%3E%3Cline x1='8' y1='23' x2='16' y2='23'%3E%3C/line%3E%3C/svg%3E");
    }
    
    .icon-mic-off {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ff6464' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cline x1='1' y1='1' x2='23' y2='23'%3E%3C/line%3E%3Cpath d='M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6'%3E%3C/path%3E%3Cpath d='M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23'%3E%3C/path%3E%3Cline x1='12' y1='19' x2='12' y2='23'%3E%3C/line%3E%3Cline x1='8' y1='23' x2='16' y2='23'%3E%3C/line%3E%3C/svg%3E");
    }
    
    .icon-video {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23fff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolygon points='23 7 16 12 23 17 23 7'%3E%3C/polygon%3E%3Crect x='1' y='5' width='15' height='14' rx='2' ry='2'%3E%3C/rect%3E%3C/svg%3E");
    }
    
    .icon-video-off {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ff6464' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M16 16v1a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2m5.66 0H14a2 2 0 0 1 2 2v3.34l1 1L23 7v10'%3E%3C/path%3E%3Cline x1='1' y1='1' x2='23' y2='23'%3E%3C/line%3E%3C/svg%3E");
    }
    
    .icon-phone {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23fff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z'%3E%3C/path%3E%3C/svg%3E");
    }
    
    .icon-phone-off {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ff6464' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M10.68 13.31a16 16 0 0 0 3.41 2.6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7 2 2 0 0 1 1.72 2v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.42 19.42 0 0 1-3.33-2.67m-2.67-3.34a19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91'%3E%3C/path%3E%3Cline x1='23' y1='1' x2='1' y2='23'%3E%3C/line%3E%3C/svg%3E");
    }
    
    .icon-send {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23fff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cline x1='22' y1='2' x2='11' y2='13'%3E%3C/line%3E%3Cpolygon points='22 2 15 22 11 13 2 9 22 2'%3E%3C/polygon%3E%3C/svg%3E");
    }
    
    .icon-emoji {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23fff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'%3E%3C/circle%3E%3Cpath d='M8 14s1.5 2 4 2 4-2 4-2'%3E%3C/path%3E%3Cline x1='9' y1='9' x2='9.01' y2='9'%3E%3C/line%3E%3Cline x1='15' y1='9' x2='15.01' y2='9'%3E%3C/line%3E%3C/svg%3E");
    }
    
    .icon-reply {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23fff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='9 14 4 9 9 4'%3E%3C/polyline%3E%3Cpath d='M20 20v-7a4 4 0 0 0-4-4H4'%3E%3C/path%3E%3C/svg%3E");
    }
    
    .icon-edit {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23fff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7'%3E%3C/path%3E%3Cpath d='M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z'%3E%3C/path%3E%3C/svg%3E");
    }
    
    .icon-delete {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ff6464' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='3 6 5 6 21 6'%3E%3C/polyline%3E%3Cpath d='M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2'%3E%3C/path%3E%3Cline x1='10' y1='11' x2='10' y2='17'%3E%3C/line%3E%3Cline x1='14' y1='11' x2='14' y2='17'%3E%3C/line%3E%3C/svg%3E");
    }
    
    .icon-mic-recording {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ff6464' stroke='%23ff6464' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z'%3E%3C/path%3E%3Cpath d='M19 10v2a7 7 0 0 1-14 0v-2'%3E%3C/path%3E%3Cline x1='12' y1='19' x2='12' y2='23'%3E%3C/line%3E%3Cline x1='8' y1='23' x2='16' y2='23'%3E%3C/line%3E%3C/svg%3E");
    }
    
    .icon-upload {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23fff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4'%3E%3C/path%3E%3Cpolyline points='17 8 12 3 7 8'%3E%3C/polyline%3E%3Cline x1='12' y1='3' x2='12' y2='15'%3E%3C/line%3E%3C/svg%3E");
    }
    
    .icon-close {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23fff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cline x1='18' y1='6' x2='6' y2='18'%3E%3C/line%3E%3Cline x1='6' y1='6' x2='18' y2='18'%3E%3C/line%3E%3C/svg%3E");
    }
    
    .camera-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .camera-btn:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.3);
    }
    
    .camera-btn.camera-off {
      background: rgba(255, 100, 100, 0.2);
      border-color: rgba(255, 100, 100, 0.3);
      color: #ff6464;
    }
    
    .call-btn, .mute-btn, .camera-btn {
      display: flex;
      align-items: center;
      gap: 6px;
    }
  </style>
</head>
<body>
  <div class="flex h-screen">
    <!-- Left Sidebar: Video Search -->
    <div id="leftPanel" class="w-80 spotlight border-r border-gray-900 flex flex-col resizable" style="min-width: 250px; max-width: 500px;">
      <div class="resize-handle resize-handle-right"></div>
      <div class="p-6 border-b border-gray-900">
        <h2 class="text-xs font-bold text-gray-400 tracking-widest mb-4 uppercase">Video Library</h2>
        <input id="searchInput" type="text" placeholder="Search videos..." 
          class="w-full px-4 py-3 rounded-lg cinema-input mb-3">
        <button onclick="searchVideos()" class="w-full py-2.5 cinema-btn rounded-lg">
          Search
        </button>
      </div>
      <div id="searchResults" class="flex-1 overflow-y-auto px-4 py-4 space-y-3">
        <div class="text-center py-16 text-gray-600">
          <div class="text-6xl mb-4 opacity-20">üé¨</div>
          <p class="text-sm font-light tracking-wide">Search for content</p>
        </div>
      </div>
    </div>

    <!-- Center: Cinema Screen -->
    <div class="flex-1 flex flex-col screen-frame">
      <div class="px-8 py-6 border-b border-gray-900 spotlight">
        <div class="flex items-center justify-between mb-6 fade-in">
          <div>
            <h1 class="text-2xl font-light text-white tracking-tight mb-1">AngSync Cinema</h1>
            <p class="text-xs text-gray-500 font-light tracking-wide">SYNCHRONIZED VIEWING EXPERIENCE</p>
          </div>
          <div id="connectionStatus" class="status-badge">
            Offline
          </div>
        </div>
        
        <div class="flex gap-4">
          <input id="roomId" type="text" placeholder="Room ID" 
            class="flex-1 px-5 py-4 rounded-lg cinema-input">
          <input id="username" type="text" placeholder="Your Name" 
            class="flex-1 px-5 py-4 rounded-lg cinema-input">
          <button onclick="joinRoom()" class="px-8 py-4 cinema-btn rounded-lg">
            Enter
          </button>
        </div>
        
        <div id="callControls" class="mt-4 call-controls" style="display: none;">
          <button id="callBtn" onclick="toggleVoiceCall()" class="call-btn">
            <span id="callIcon" class="icon icon-phone"></span>
            <span id="callText">Start Call</span>
          </button>
          <button id="muteBtn" onclick="toggleMute()" class="mute-btn" style="display: none;">
            <span id="muteIcon" class="icon icon-mic"></span>
            <span id="muteText">Mute</span>
          </button>
          <button id="cameraBtn" onclick="toggleCamera()" class="camera-btn" style="display: none;">
            <span id="cameraIcon" class="icon icon-video-off"></span>
            <span id="cameraText">Camera</span>
          </button>
          <div id="callStatus" class="call-status" style="display: none;"></div>
          <div id="participantsCount" class="participants-count" style="display: none;"></div>
        </div>
      </div>
      
      <div class="flex-1 flex items-center justify-center p-10">
        <div class="w-full h-full relative max-w-7xl mx-auto">
          <div id="player" class="w-full h-full bg-black"></div>
          <div id="noVideo" class="absolute inset-0 flex items-center justify-center bg-black">
            <div class="text-center">
              <div class="w-32 h-32 mx-auto mb-8 rounded-full border-2 border-gray-900 flex items-center justify-center cinema-glow">
                <div class="text-6xl opacity-20">‚ñ∂</div>
              </div>
              <h3 class="text-xl font-light text-white mb-2 tracking-wide">No Content Selected</h3>
              <p class="text-gray-600 text-sm font-light">Browse and select a video to begin</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Video Grid -->
    <div id="videoGrid" class="video-grid">
      <div class="video-grid-header" id="videoGridHeader">
        <div class="video-grid-title">
          <span class="drag-icon"></span>
          <span>Video Call</span>
        </div>
      </div>
      <div class="video-grid-content" id="videoGridContent"></div>
    </div>

    <!-- Right Sidebar: Chat -->
    <div id="rightPanel" class="w-80 spotlight border-l border-gray-900 flex flex-col resizable" style="min-width: 250px; max-width: 500px;">
      <div class="resize-handle resize-handle-left"></div>
      <div class="p-6 border-b border-gray-900">
        <h2 class="text-xs font-bold text-gray-400 tracking-widest uppercase">Live Discussion</h2>
      </div>
      <div id="chatMessages" class="flex-1 overflow-y-auto px-4 py-4 space-y-4">
        <div class="text-center text-gray-600 py-16">
          <div class="text-6xl mb-4 opacity-20">üí¨</div>
          <p class="text-sm font-light tracking-wide">Join a room to chat</p>
        </div>
      </div>
      <div class="p-4 border-t border-gray-900">
        <div id="editBanner" class="edit-banner">
          <span class="text-xs text-gray-400">Editing message</span>
          <button onclick="cancelEdit()" class="reply-close" title="Cancel edit">‚úï</button>
        </div>
        <div id="replyBanner" class="reply-banner">
          <span class="text-xs text-gray-400">Replying to</span>
          <span id="replyToUser" class="text-xs font-semibold text-white"></span>
          <button onclick="cancelReply()" class="reply-close" title="Cancel reply">‚úï</button>
        </div>
        <div class="flex gap-2 relative">
          <div class="relative flex-1">
            <div id="mediaPreview" class="media-preview">
              <div class="media-preview-header">
                <span class="text-xs text-gray-400">Attachment</span>
                <button onclick="clearMediaAttachment()" class="media-preview-close">
                  <span class="icon icon-close" style="width: 12px; height: 12px;"></span>
                </button>
              </div>
              <div id="mediaPreviewContent"></div>
            </div>
            <div id="emojiPicker" class="emoji-picker">
              <div class="emoji-grid" id="emojiGrid"></div>
            </div>
            <input id="chatInput" type="text" placeholder="Message..." 
              class="w-full px-4 py-3 rounded-lg cinema-input text-sm" 
              onkeypress="if(event.key==='Enter') sendMessage()">
          </div>
          <input type="file" id="mediaInput" accept="image/*,video/*" style="display: none;" onchange="handleMediaUpload(event)">
          <button onclick="document.getElementById('mediaInput').click()" class="px-4 py-3 cinema-btn-secondary rounded-lg upload-btn" title="Upload image/video">
            <span class="icon icon-upload"></span>
          </button>
          <div class="relative">
            <div id="recordingTimer" class="recording-timer">0:00</div>
            <button id="voiceBtn" onclick="toggleVoiceRecording()" class="px-4 py-3 cinema-btn-secondary rounded-lg voice-btn" title="Record voice note">
              <span class="icon icon-mic"></span>
            </button>
          </div>
          <button onclick="toggleEmojiPicker()" class="px-4 py-3 cinema-btn-secondary rounded-lg emoji-btn" title="Add emoji">
            <span class="icon icon-emoji"></span>
          </button>
          <button onclick="sendMessage()" class="px-4 py-3 cinema-btn-secondary rounded-lg send-btn">
            <span class="icon icon-send"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    let ws;
    let player;
    let roomId;
    let username;
    let currentVideoUrl = null;
    let isSeeking = false;
    let isPaused = false;
    let isPlaying = false;
    let replyToMessage = null;
    let editingMessage = null;
    const messageMap = new Map();
    let mediaRecorder = null;
    let audioChunks = [];
    let recordingStartTime = null;
    let recordingInterval = null;
    let currentMediaAttachment = null;
    let audioPlayers = new Map();
    const messageReactions = new Map();
    let activeReactionPicker = null;
    let inCall = false;
    let isMuted = false;
    let cameraEnabled = false;
    let localStream = null;
    let peerConnections = new Map();
    const remoteStreams = new Map();
    
    // Drag functionality
    let isDragging = false;
    let dragOffsetX = 0;
    let dragOffsetY = 0;
    
    const iceServers = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
      ]
    };

    // YouTube Search
    async function searchVideos() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return;

      const resultsDiv = document.getElementById('searchResults');
      resultsDiv.innerHTML = '<div class="text-center py-8 text-gray-300"><span class="loading-spinner"></span>Searching...</div>';

      try {
        const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
        const videos = await response.json();
        
        if (videos.length === 0) {
          resultsDiv.innerHTML = '<div class="text-center py-4 text-gray-400">No videos found</div>';
          return;
        }

        resultsDiv.innerHTML = '';
        videos.forEach(video => {
          const div = document.createElement('div');
          div.className = 'video-result p-4 rounded-xl cursor-pointer';
          div.innerHTML = `
            <div class="flex gap-4">
              <img src="${video.thumbnail}" class="w-24 h-16 rounded-lg object-cover flex-shrink-0 border border-gray-800">
              <div class="flex-1 min-w-0">
                <h4 class="font-medium text-sm text-white mb-2 line-clamp-2 leading-snug">${video.title}</h4>
                <p class="text-xs text-gray-500 mb-1 font-light">${video.author}</p>
                <p class="text-xs text-gray-600 font-mono">${video.duration}</p>
              </div>
            </div>
          `;
          div.onclick = () => selectVideo(video.url, div);
          resultsDiv.appendChild(div);
        });
      } catch (error) {
        resultsDiv.innerHTML = '<div class="text-center py-8 text-gray-600 text-sm font-light">Search failed. Try again.</div>';
      }
    }

    function selectVideo(url, element) {
      document.querySelectorAll('.video-result').forEach(el => el.classList.remove('playing'));
      element.classList.add('playing');
      
      currentVideoUrl = url;
      console.log('üé¨ Selected video:', url);
      console.log('WebSocket state:', ws ? ws.readyState : 'null', 'Room ID:', roomId);
      
      loadVideo(url);
      
      // Send to room if connected
      if (!roomId) {
        console.warn('‚ö†Ô∏è No room joined yet. Video will be broadcast when you join a room.');
        return;
      }
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        const message = { roomId, action: 'changeUrl', url };
        console.log('üì§ Sending changeUrl to room:', message);
        ws.send(JSON.stringify(message));
      } else {
        console.warn('‚ö†Ô∏è WebSocket not ready - ws:', !!ws, 'state:', ws?.readyState, 'Room:', roomId);
        console.log('Video will be broadcast when connection is established');
      }
    }

    function joinRoom() {
      const enteredRoomId = document.getElementById('roomId').value.trim();
      const enteredUsername = document.getElementById('username').value.trim();
      
      if (!enteredRoomId) {
        alert("Please enter a Room ID");
        return;
      }
      
      if (!enteredUsername) {
        alert("Please enter your name");
        return;
      }

      // If already connected to the same room, don't reconnect
      if (ws && ws.readyState === WebSocket.OPEN && roomId === enteredRoomId) {
        console.log('‚ö†Ô∏è Already connected to room', roomId);
        return;
      }

      // Close existing connection if any
      if (ws) {
        ws.onclose = null; // Prevent onclose handler from triggering
        ws.close();
      }

      roomId = enteredRoomId;
      username = enteredUsername;
      
      // Update status
      const statusDiv = document.getElementById('connectionStatus');
      statusDiv.textContent = 'Connecting';
      statusDiv.className = 'status-badge status-connecting';

      ws = new WebSocket('ws://localhost:8080');

      ws.onopen = () => {
        console.log('‚úÖ WebSocket connected');
        statusDiv.textContent = `Room ${roomId}`;
        statusDiv.className = 'status-badge status-connected';
        ws.send(JSON.stringify({ roomId, username, action: 'join' }));
        
        // Clear chat messages
        document.getElementById('chatMessages').innerHTML = '';
        
        // If a video was already selected before joining, broadcast it to the room
        if (currentVideoUrl) {
          console.log('üì§ Broadcasting previously selected video:', currentVideoUrl);
          setTimeout(() => {
            ws.send(JSON.stringify({ roomId, action: 'changeUrl', url: currentVideoUrl }));
          }, 100);
        }
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log('üì© Received:', data.type, data.time);

        switch (data.type) {
          case 'userCount':
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.textContent = `${data.count} Online ‚Ä¢ Room ${roomId}`;
            statusDiv.className = 'status-badge status-connected';
            // Show call controls when joined
            document.getElementById('callControls').style.display = 'flex';
            break;
          case 'sync':
          case 'changeUrl':
            console.log('üì∫ Received sync/changeUrl - URL:', data.url, 'Time:', data.time);
            if (data.url) {
              currentVideoUrl = data.url;
              console.log('üì∫ Loading video:', data.url);
              loadVideo(data.url);
              if (data.time > 0) {
                setTimeout(() => {
                  if (player) player.seekTo(data.time, true);
                }, 1000);
              }
            } else {
              console.log('‚ÑπÔ∏è No video in room yet');
            }
            break;
          case 'play':
            if (player && !isPlaying) {
              isSeeking = true;
              isPlaying = true;
              isPaused = false;
              player.seekTo(data.time, true);
              player.playVideo();
              setTimeout(() => isSeeking = false, 500);
              console.log('‚ñ∂Ô∏è Playing');
            }
            break;
          case 'pause':
            if (player && !isPaused) {
              isSeeking = true;
              isPaused = true;
              isPlaying = false;
              player.seekTo(data.time, true);
              player.pauseVideo();
              setTimeout(() => isSeeking = false, 500);
              console.log('‚è∏ Paused');
            }
            break;
          case 'seek':
            if (player && !isSeeking) {
              const currentTime = player.getCurrentTime();
              if (Math.abs(currentTime - data.time) > 2) {
                isSeeking = true;
                player.seekTo(data.time, true);
                setTimeout(() => isSeeking = false, 500);
                console.log('‚è© Seeked to', data.time);
              }
            }
            break;
          case 'chat':
            displayChatMessage(data.username, data.message, data.username === username, data.replyTo, data.messageId, false);
            break;
          case 'mediaMessage':
            displayMediaMessage(data.username, data.message, data.mediaType, data.mediaData, data.username === username, data.replyTo, data.messageId);
            break;
          case 'editChat':
            console.log('üìù Message edited:', data.messageId);
            if (messageMap.has(data.messageId)) {
              const msgDiv = messageMap.get(data.messageId);
              const isMe = data.username === username;
              displayChatMessage(data.username, data.message, isMe, null, data.messageId, true);
            }
            break;
          
          case 'deleteMessage':
            console.log('üóëÔ∏è Message deleted:', data.messageId);
            if (messageMap.has(data.messageId)) {
              const msgDiv = messageMap.get(data.messageId);
              // Replace content with deleted message indicator
              msgDiv.innerHTML = `
                <div class="rounded-2xl px-5 py-3 max-w-xs" style="background: rgba(50,50,50,0.3); border: 1px solid rgba(100,100,100,0.2);">
                  <div class="text-xs text-gray-500 italic">Message has been deleted</div>
                </div>
              `;
            }
            break;
          
          case 'voiceNote':
            displayVoiceMessage(data.username, data.audioData, data.duration, data.username === username, data.messageId, data.replyTo);
            break;
          case 'reaction':
            if (data.reactions) {
              messageReactions.set(data.messageId, data.reactions);
              displayReactions(data.messageId, data.reactions);
            }
            break;
          case 'userJoinedCall':
            console.log('üìû', data.username, 'joined the call');
            if (inCall && data.username !== username) {
              // Initiate connection with the new caller
              setTimeout(() => initiateCallWith(data.username), 1000);
            }
            updateCallParticipants(data.participants);
            break;
          case 'userLeftCall':
            console.log('üìû', data.username, 'left the call');
            const pc = peerConnections.get(data.username);
            if (pc) {
              pc.close();
              peerConnections.delete(data.username);
            }
            removeRemoteVideo(data.username);
            updateCallParticipants(data.participants);
            break;
          case 'callSignal':
            handleCallSignaling(data);
            break;
        }
      };

      ws.onerror = (error) => {
        console.error('‚ùå WebSocket error:', error);
        const statusDiv = document.getElementById('connectionStatus');
        statusDiv.textContent = 'Error';
        statusDiv.className = 'status-badge status-error';
      };
      
      ws.onclose = () => {
        console.log('‚ö†Ô∏è WebSocket disconnected');
        const statusDiv = document.getElementById('connectionStatus');
        statusDiv.textContent = 'Offline';
        statusDiv.className = 'status-badge';
        
        // End call if disconnected
        if (inCall) {
          endVoiceCall();
        }
      };
    }
    
    // Voice Call Functions
    async function toggleVoiceCall() {
      if (inCall) {
        endVoiceCall();
      } else {
        await startVoiceCall();
      }
    }
    
    async function startVoiceCall() {
      try {
        const constraints = {
          audio: true,
          video: cameraEnabled ? {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            facingMode: 'user'
          } : false
        };
        
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        // Display local video if camera is enabled
        if (cameraEnabled) {
          displayLocalVideo();
        }
        
        inCall = true;
        updateCallUI();
        
        // Notify server that we joined the call
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({
            roomId,
            action: 'joinCall',
            username,
            hasVideo: cameraEnabled
          }));
        }
        
        console.log('üìû Joined voice call', cameraEnabled ? 'with video' : '(audio only)');
      } catch (error) {
        console.error('Error accessing media devices:', error);
        alert('Could not access microphone/camera. Please grant permission.');
      }
    }
    
    function endVoiceCall() {
      // Stop local stream
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      
      // Close all peer connections
      peerConnections.forEach(pc => pc.close());
      peerConnections.clear();
      
      // Clear remote streams
      remoteStreams.clear();
      
      // Clear video grid content
      const videoGridContent = document.getElementById('videoGridContent');
      if (videoGridContent) {
        videoGridContent.innerHTML = '';
      }
      document.getElementById('videoGrid').classList.remove('show');
      
      inCall = false;
      isMuted = false;
      cameraEnabled = false;
      updateCallUI();
      
      // Notify server that we left the call
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          roomId,
          action: 'leaveCall',
          username
        }));
      }
      
      console.log('üìû Left voice call');
    }
    
    function toggleMute() {
      if (!localStream) return;
      
      isMuted = !isMuted;
      localStream.getAudioTracks().forEach(track => {
        track.enabled = !isMuted;
      });
      
      updateCallUI();
      updateLocalVideoIndicator();
      console.log(isMuted ? 'üîá Muted' : 'üîä Unmuted');
    }
    
    async function toggleCamera() {
      if (!inCall) {
        // Toggle camera before starting call
        cameraEnabled = !cameraEnabled;
        updateCallUI();
        return;
      }
      
      // Toggle camera during call
      cameraEnabled = !cameraEnabled;
      
      if (cameraEnabled) {
        // Add video track
        try {
          const videoStream = await navigator.mediaDevices.getUserMedia({ 
            video: {
              width: { ideal: 1280 },
              height: { ideal: 720 },
              facingMode: 'user'
            }
          });
          
          const videoTrack = videoStream.getVideoTracks()[0];
          localStream.addTrack(videoTrack);
          
          // Add track to all peer connections
          peerConnections.forEach((pc, username) => {
            const sender = pc.getSenders().find(s => s.track?.kind === 'video');
            if (!sender) {
              pc.addTrack(videoTrack, localStream);
            }
          });
          
          displayLocalVideo();
        } catch (error) {
          console.error('Error enabling camera:', error);
          cameraEnabled = false;
        }
      } else {
        // Remove video track
        const videoTracks = localStream.getVideoTracks();
        videoTracks.forEach(track => {
          track.stop();
          localStream.removeTrack(track);
        });
        
        // Remove from peer connections
        peerConnections.forEach(pc => {
          const sender = pc.getSenders().find(s => s.track?.kind === 'video');
          if (sender) {
            pc.removeTrack(sender);
          }
        });
        
        // Remove local video element
        const localVideo = document.getElementById('localVideo');
        if (localVideo) {
          localVideo.parentElement.remove();
        }
      }
      
      updateCallUI();
      
      // Notify peers about video state change
      ws.send(JSON.stringify({
        roomId,
        action: 'videoStateChange',
        username,
        hasVideo: cameraEnabled
      }));
      
      console.log(cameraEnabled ? 'üìπ Camera on' : 'üö´ Camera off');
    }
    
    function updateCallUI() {
      const callBtn = document.getElementById('callBtn');
      const callIcon = document.getElementById('callIcon');
      const callText = document.getElementById('callText');
      const muteBtn = document.getElementById('muteBtn');
      const muteIcon = document.getElementById('muteIcon');
      const muteText = document.getElementById('muteText');
      const cameraBtn = document.getElementById('cameraBtn');
      const cameraIcon = document.getElementById('cameraIcon');
      const cameraText = document.getElementById('cameraText');
      const callStatus = document.getElementById('callStatus');
      
      if (inCall) {
        callBtn.classList.add('in-call');
        callIcon.className = 'icon icon-phone-off';
        callText.textContent = 'Leave Call';
        muteBtn.style.display = 'flex';
        cameraBtn.style.display = 'flex';
        callStatus.style.display = 'block';
        callStatus.textContent = cameraEnabled ? 'Video Call' : 'Voice Call';
        
        if (isMuted) {
          muteBtn.classList.add('muted');
          muteIcon.className = 'icon icon-mic-off';
          muteText.textContent = 'Unmute';
        } else {
          muteBtn.classList.remove('muted');
          muteIcon.className = 'icon icon-mic';
          muteText.textContent = 'Mute';
        }
        
        if (cameraEnabled) {
          cameraBtn.classList.remove('camera-off');
          cameraIcon.className = 'icon icon-video';
          cameraText.textContent = 'Camera On';
        } else {
          cameraBtn.classList.add('camera-off');
          cameraIcon.className = 'icon icon-video-off';
          cameraText.textContent = 'Camera Off';
        }
      } else {
        callBtn.classList.remove('in-call');
        callIcon.className = 'icon icon-phone';
        callText.textContent = cameraEnabled ? 'Start Video Call' : 'Start Call';
        muteBtn.style.display = 'none';
        cameraBtn.style.display = 'flex';
        callStatus.style.display = 'none';
        
        if (cameraEnabled) {
          cameraBtn.classList.remove('camera-off');
          cameraIcon.className = 'icon icon-video';
          cameraText.textContent = 'With Video';
        } else {
          cameraBtn.classList.add('camera-off');
          cameraIcon.className = 'icon icon-video-off';
          cameraText.textContent = 'Audio Only';
        }
      }
    }
    
    async function handleCallSignaling(data) {
      const { from, type, offer, answer, candidate } = data;
      
      if (type === 'offer') {
        // Received an offer from another peer
        const pc = createPeerConnection(from);
        await pc.setRemoteDescription(new RTCSessionDescription(offer));
        const answerDesc = await pc.createAnswer();
        await pc.setLocalDescription(answerDesc);
        
        // Send answer back
        ws.send(JSON.stringify({
          roomId,
          action: 'callSignal',
          to: from,
          from: username,
          type: 'answer',
          answer: answerDesc
        }));
      } else if (type === 'answer') {
        // Received an answer
        const pc = peerConnections.get(from);
        if (pc) {
          await pc.setRemoteDescription(new RTCSessionDescription(answer));
        }
      } else if (type === 'ice-candidate' && candidate) {
        // Received ICE candidate
        const pc = peerConnections.get(from);
        if (pc) {
          await pc.addIceCandidate(new RTCIceCandidate(candidate));
        }
      }
    }
    
    function createPeerConnection(remoteUsername) {
      if (peerConnections.has(remoteUsername)) {
        return peerConnections.get(remoteUsername);
      }
      
      const pc = new RTCPeerConnection(iceServers);
      peerConnections.set(remoteUsername, pc);
      
      // Add local stream
      if (localStream) {
        localStream.getTracks().forEach(track => {
          pc.addTrack(track, localStream);
        });
      }
      
      // Handle ICE candidates
      pc.onicecandidate = (event) => {
        if (event.candidate) {
          ws.send(JSON.stringify({
            roomId,
            action: 'callSignal',
            to: remoteUsername,
            from: username,
            type: 'ice-candidate',
            candidate: event.candidate
          }));
        }
      };
      
      // Handle incoming stream
      pc.ontrack = (event) => {
        console.log('üì° Receiving stream from', remoteUsername);
        
        const stream = event.streams[0];
        const hasVideo = stream.getVideoTracks().length > 0;
        
        if (hasVideo) {
          displayRemoteVideo(remoteUsername, stream);
        } else {
          // Audio only - just play it
          const audio = new Audio();
          audio.srcObject = stream;
          audio.play();
        }
      };
      
      pc.onconnectionstatechange = () => {
        console.log('Connection state with', remoteUsername, ':', pc.connectionState);
        if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
          removeRemoteVideo(remoteUsername);
          peerConnections.delete(remoteUsername);
          pc.close();
        }
      };
      
      return pc;
    }
    
    function displayLocalVideo() {
      const videoGrid = document.getElementById('videoGrid');
      const videoGridContent = document.getElementById('videoGridContent');
      videoGrid.classList.add('show');
      
      // Remove existing local video if any
      const existingLocal = document.getElementById('localVideo');
      if (existingLocal) {
        existingLocal.parentElement.remove();
      }
      
      const container = document.createElement('div');
      container.className = 'video-container local-video';
      container.innerHTML = `
        <video id="localVideo" autoplay muted playsinline></video>
        <div class="video-label">You</div>
        <div id="localAudioIndicator" class="video-audio-indicator">
          <span class="icon icon-mic"></span>
        </div>
      `;
      
      videoGridContent.insertBefore(container, videoGridContent.firstChild);
      
      const video = document.getElementById('localVideo');
      video.srcObject = localStream;
      
      updateLocalVideoIndicator();
    }
    
    function updateLocalVideoIndicator() {
      const indicator = document.getElementById('localAudioIndicator');
      if (indicator) {
        const icon = indicator.querySelector('.icon');
        if (isMuted) {
          indicator.classList.add('muted');
          icon.className = 'icon icon-mic-off';
        } else {
          indicator.classList.remove('muted');
          icon.className = 'icon icon-mic';
        }
      }
    }
    
    function displayRemoteVideo(remoteUsername, stream) {
      const videoGrid = document.getElementById('videoGrid');
      const videoGridContent = document.getElementById('videoGridContent');
      videoGrid.classList.add('show');
      
      const videoId = `video-${remoteUsername.replace(/\s/g, '-')}`;
      
      // Remove existing video if any
      const existing = document.getElementById(videoId);
      if (existing) {
        existing.parentElement.remove();
      }
      
      const container = document.createElement('div');
      container.className = 'video-container';
      container.innerHTML = `
        <video id="${videoId}" autoplay playsinline></video>
        <div class="video-label">${remoteUsername}</div>
        <div class="video-audio-indicator">
          <span class="icon icon-mic"></span>
        </div>
      `;
      
      videoGridContent.appendChild(container);
      
      const video = document.getElementById(videoId);
      video.srcObject = stream;
      
      remoteStreams.set(remoteUsername, stream);
    }
    
    function removeRemoteVideo(remoteUsername) {
      const videoId = `video-${remoteUsername.replace(/\s/g, '-')}`;
      const video = document.getElementById(videoId);
      if (video && video.parentElement) {
        video.parentElement.remove();
      }
      remoteStreams.delete(remoteUsername);
      
      // Hide video grid if no videos
      const videoGrid = document.getElementById('videoGrid');
      if (videoGrid.children.length === 0) {
        videoGrid.classList.remove('show');
      }
    }
    
    async function initiateCallWith(remoteUsername) {
      const pc = createPeerConnection(remoteUsername);
      const offerDesc = await pc.createOffer();
      await pc.setLocalDescription(offerDesc);
      
      // Send offer
      ws.send(JSON.stringify({
        roomId,
        action: 'callSignal',
        to: remoteUsername,
        from: username,
        type: 'offer',
        offer: offerDesc
      }));
    }

    function loadVideo(url) {
      const videoId = extractVideoId(url);
      if (!videoId) return;

      document.getElementById('noVideo').style.display = 'none';
      
      if (player) {
        player.loadVideoById(videoId);
      }
    }

    function extractVideoId(url) {
      const match = url.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
      return match ? match[1] : null;
    }

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '100%',
        width: '100%',
        playerVars: { 'autoplay': 0, 'controls': 1, 'rel': 0, 'modestbranding': 1 },
        events: {
          'onReady': () => {
            console.log('‚úÖ Player ready');
            initializeDrag();
          },
          'onStateChange': onPlayerStateChange
        }
      });
    }
    
    function initializeDrag() {
      const videoGrid = document.getElementById('videoGrid');
      const header = document.getElementById('videoGridHeader');
      
      header.addEventListener('mousedown', (e) => {
        isDragging = true;
        const rect = videoGrid.getBoundingClientRect();
        dragOffsetX = e.clientX - rect.left;
        dragOffsetY = e.clientY - rect.top;
        header.style.cursor = 'grabbing';
      });
      
      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        
        e.preventDefault();
        const videoGrid = document.getElementById('videoGrid');
        let newLeft = e.clientX - dragOffsetX;
        let newTop = e.clientY - dragOffsetY;
        
        // Constrain to viewport
        const maxLeft = window.innerWidth - videoGrid.offsetWidth;
        const maxTop = window.innerHeight - videoGrid.offsetHeight;
        
        newLeft = Math.max(0, Math.min(newLeft, maxLeft));
        newTop = Math.max(0, Math.min(newTop, maxTop));
        
        videoGrid.style.left = newLeft + 'px';
        videoGrid.style.top = newTop + 'px';
        videoGrid.style.right = 'auto';
        videoGrid.style.bottom = 'auto';
      });
      
      document.addEventListener('mouseup', () => {
        if (isDragging) {
          isDragging = false;
          header.style.cursor = 'move';
        }
      });
    }

    function onPlayerStateChange(event) {
      if (!ws || ws.readyState !== WebSocket.OPEN || isSeeking) return;

      const currentTime = player.getCurrentTime();

      if (event.data === YT.PlayerState.PLAYING) {
        isPlaying = true;
        isPaused = false;
        if (roomId) ws.send(JSON.stringify({ roomId, action: 'play', time: currentTime }));
      } else if (event.data === YT.PlayerState.PAUSED) {
        isPlaying = false;
        isPaused = true;
        if (roomId) ws.send(JSON.stringify({ roomId, action: 'pause', time: currentTime }));
      }
    }

    let lastSyncTime = 0;
    setInterval(() => {
      if (player && ws && ws.readyState === WebSocket.OPEN && roomId && !isSeeking) {
        try {
          if (player.getPlayerState() === YT.PlayerState.PLAYING) {
            const currentTime = player.getCurrentTime();
            if (Math.abs(currentTime - lastSyncTime) > 0.5) {
              lastSyncTime = currentTime;
              ws.send(JSON.stringify({ roomId, action: 'seek', time: currentTime }));
            }
          }
        } catch (e) {}
      }
    }, 1000);

    document.addEventListener('keypress', (e) => {
      if (e.target.id === 'searchInput' && e.key === 'Enter') searchVideos();
      if (e.target.id === 'roomId' && e.key === 'Enter') {
        document.getElementById('username').focus();
      }
      if (e.target.id === 'username' && e.key === 'Enter') joinRoom();
    });

    function handleMediaUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Validate file type
      const isImage = file.type.startsWith('image/');
      const isVideo = file.type.startsWith('video/');
      
      if (!isImage && !isVideo) {
        alert('Please select an image or video file');
        return;
      }

      // Validate file size (10MB limit)
      const maxSize = 10 * 1024 * 1024; // 10MB
      if (file.size > maxSize) {
        alert('File size must be less than 10MB');
        event.target.value = '';
        return;
      }

      // Read file and convert to base64
      const reader = new FileReader();
      reader.onload = function(e) {
        const base64Data = e.target.result;
        
        // Store attachment
        currentMediaAttachment = {
          type: isImage ? 'image' : 'video',
          data: base64Data,
          filename: file.name
        };

        // Show preview
        const previewContent = document.getElementById('mediaPreviewContent');
        if (isImage) {
          previewContent.innerHTML = `<img src="${base64Data}" alt="Preview">`;
        } else {
          previewContent.innerHTML = `<video src="${base64Data}" controls></video>`;
        }
        
        document.getElementById('mediaPreview').classList.add('show');
        document.getElementById('chatInput').focus();
      };

      reader.onerror = function() {
        alert('Error reading file. Please try again.');
        event.target.value = '';
      };

      reader.readAsDataURL(file);
    }

    function clearMediaAttachment() {
      currentMediaAttachment = null;
      document.getElementById('mediaPreview').classList.remove('show');
      document.getElementById('mediaPreviewContent').innerHTML = '';
      document.getElementById('mediaInput').value = '';
    }

    function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      // Check if we have media or text
      if (!message && !currentMediaAttachment) return;
      
      if (!ws || ws.readyState !== WebSocket.OPEN || !roomId) {
        alert('Please join a room first!');
        return;
      }
      
      if (editingMessage) {
        // Send edit action
        const editData = {
          roomId,
          action: 'editChat',
          username,
          messageId: editingMessage.id,
          newMessage: message
        };
        ws.send(JSON.stringify(editData));
        input.value = '';
        cancelEdit();
      } else if (currentMediaAttachment) {
        // Send media message
        const messageId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const messageData = { 
          roomId, 
          action: 'mediaMessage', 
          username,
          message: message || '', // Optional caption
          messageId,
          mediaType: currentMediaAttachment.type,
          mediaData: currentMediaAttachment.data,
          filename: currentMediaAttachment.filename
        };
        
        if (replyToMessage) {
          messageData.replyTo = {
            username: replyToMessage.username,
            message: replyToMessage.message
          };
        }
        
        ws.send(JSON.stringify(messageData));
        
        input.value = '';
        clearMediaAttachment();
        cancelReply();
      } else {
        // Send new text message
        const messageId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const messageData = { 
          roomId, 
          action: 'chat', 
          username,
          message,
          messageId
        };
        
        if (replyToMessage) {
          messageData.replyTo = {
            username: replyToMessage.username,
            message: replyToMessage.message
          };
        }
        
        ws.send(JSON.stringify(messageData));
        
        input.value = '';
        cancelReply();
      }
    }
    
    function setReplyTo(sender, message) {
      replyToMessage = { username: sender, message: message, type: 'text' };
      document.getElementById('replyToUser').textContent = sender;
      document.getElementById('replyBanner').classList.add('show');
      document.getElementById('chatInput').focus();
    }
    
    function setReplyToVoice(sender, duration, messageId) {
      const minutes = Math.floor(duration / 60);
      const seconds = duration % 60;
      const durationText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      replyToMessage = { username: sender, message: `üé§ Voice message (${durationText})`, type: 'voice', messageId };
      document.getElementById('replyToUser').textContent = sender;
      document.getElementById('replyBanner').classList.add('show');
      document.getElementById('chatInput').focus();
    }
    
    function cancelReply() {
      replyToMessage = null;
      document.getElementById('replyBanner').classList.remove('show');
    }
    
    function editMessage(messageId, currentMessage) {
      editingMessage = { id: messageId, message: currentMessage };
      document.getElementById('editBanner').classList.add('show');
      const input = document.getElementById('chatInput');
      input.value = currentMessage;
      input.focus();
      
      // Cancel reply if active
      cancelReply();
    }
    
    function cancelEdit() {
      editingMessage = null;
      document.getElementById('editBanner').classList.remove('show');
      document.getElementById('chatInput').value = '';
    }
    
    function deleteMessage(messageId) {
      if (!ws || ws.readyState !== WebSocket.OPEN || !roomId) {
        alert('Not connected to room!');
        return;
      }
      
      ws.send(JSON.stringify({
        roomId,
        action: 'deleteMessage',
        messageId
      }));
    }
    
    // Voice Recording
    async function toggleVoiceRecording() {
      const voiceBtn = document.getElementById('voiceBtn');
      const voiceBtnIcon = voiceBtn.querySelector('.icon');
      const timerDiv = document.getElementById('recordingTimer');
      
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        // Stop recording
        mediaRecorder.stop();
        voiceBtn.classList.remove('recording');
        voiceBtnIcon.className = 'icon icon-mic';
        timerDiv.classList.remove('show');
        clearInterval(recordingInterval);
      } else {
        // Start recording
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          audioChunks = [];
          mediaRecorder = new MediaRecorder(stream);
          
          mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
          };
          
          mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const reader = new FileReader();
            
            reader.onloadend = () => {
              const base64Audio = reader.result.split(',')[1];
              const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
              
              if (!ws || ws.readyState !== WebSocket.OPEN || !roomId) {
                alert('Please join a room first!');
                return;
              }
              
              const messageId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
              const voiceData = {
                roomId,
                action: 'voiceNote',
                username,
                audioData: base64Audio,
                duration,
                messageId
              };
              
              if (replyToMessage) {
                voiceData.replyTo = {
                  username: replyToMessage.username,
                  message: replyToMessage.message
                };
              }
              
              ws.send(JSON.stringify(voiceData));
              cancelReply();
            };
            
            reader.readAsDataURL(audioBlob);
            stream.getTracks().forEach(track => track.stop());
          };
          
          recordingStartTime = Date.now();
          mediaRecorder.start();
          voiceBtn.classList.add('recording');
          voiceBtnIcon.className = 'icon icon-mic-recording';
          timerDiv.classList.add('show');
          
          // Update timer
          recordingInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            timerDiv.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
          }, 100);
          
        } catch (error) {
          console.error('Error accessing microphone:', error);
          alert('Could not access microphone. Please grant permission.');
        }
      }
    }
    
    function playVoiceNote(messageId, audioData) {
      const playBtn = document.querySelector(`[data-voice-id="${messageId}"] .voice-play-btn`);
      const bars = document.querySelectorAll(`[data-voice-id="${messageId}"] .voice-bar`);
      
      if (audioPlayers.has(messageId)) {
        const audio = audioPlayers.get(messageId);
        if (!audio.paused) {
          audio.pause();
          audio.currentTime = 0;
          playBtn.classList.remove('playing');
          playBtn.innerHTML = '‚ñ∂';
          bars.forEach(bar => bar.style.background = 'rgba(255,255,255,0.3)');
          audioPlayers.delete(messageId);
          return;
        }
      }
      
      const audio = new Audio('data:audio/webm;base64,' + audioData);
      audioPlayers.set(messageId, audio);
      
      playBtn.classList.add('playing');
      playBtn.innerHTML = '‚è∏';
      
      // Animate bars
      let barIndex = 0;
      const animateInterval = setInterval(() => {
        bars.forEach((bar, i) => {
          if (i === barIndex % bars.length) {
            bar.style.background = 'rgba(255,255,255,0.8)';
            bar.style.height = Math.random() * 24 + 8 + 'px';
          } else {
            bar.style.background = 'rgba(255,255,255,0.3)';
          }
        });
        barIndex++;
      }, 100);
      
      audio.onended = () => {
        clearInterval(animateInterval);
        playBtn.classList.remove('playing');
        playBtn.innerHTML = '‚ñ∂';
        bars.forEach(bar => {
          bar.style.background = 'rgba(255,255,255,0.3)';
          bar.style.height = '16px';
        });
        audioPlayers.delete(messageId);
      };
      
      audio.play();
    }
    
    function displayVoiceMessage(sender, audioData, duration, isMe, messageId, replyTo) {
      const chatDiv = document.getElementById('chatMessages');
      const msgDiv = document.createElement('div');
      msgDiv.className = 'chat-message';
      msgDiv.style.position = 'relative';
      
      const bubbleClass = isMe ? 'my-message' : 'other-message';
      
      // Generate waveform bars
      const barCount = 20;
      let barsHtml = '';
      for (let i = 0; i < barCount; i++) {
        const height = Math.random() * 16 + 8;
        barsHtml += `<div class="voice-bar" style="height: ${height}px"></div>`;
      }
      
      const minutes = Math.floor(duration / 60);
      const seconds = duration % 60;
      const durationText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      let replyHtml = '';
      if (replyTo) {
        replyHtml = `
          <div class="reply-indicator">
            <div class="font-semibold">${escapeHtml(replyTo.username)}</div>
            <div class="truncate">${escapeHtml(replyTo.message.substring(0, 50))}${replyTo.message.length > 50 ? '...' : ''}</div>
          </div>
        `;
      }
      
      const replyBtnHtml = `<button class="reply-btn" onclick='setReplyToVoice("${sender.replace(/"/g, '&quot;')}", ${duration}, "${messageId}")'><span class="icon icon-reply"></span></button>`;
      const deleteBtnHtml = isMe ? `<button class="delete-btn" onclick='deleteMessage("${messageId}")'><span class="icon icon-delete"></span></button>` : '';
      
      let reactionPickerHtml = '';
      if (messageId) {
        reactionPickerHtml = `
          <div id="reaction-picker-${messageId}" class="reaction-picker">
            ${quickReactions.map(emoji => `<button class="reaction-option" onclick='addReaction("${messageId}", "${emoji}")'>${emoji}</button>`).join('')}
          </div>
          <button class="react-btn" onclick='toggleReactionPicker("${messageId}", event)'>üëç</button>
        `;
      }
      
      msgDiv.innerHTML = `
        <div class="${bubbleClass} rounded-2xl px-5 py-3 ${isMe ? 'ml-auto' : 'mr-auto'}" style="position: relative; max-width: 320px; padding-bottom: 2rem;">
          ${reactionPickerHtml}
          ${deleteBtnHtml}
          ${replyBtnHtml}
          <div class="text-xs font-semibold mb-3 ${isMe ? 'text-gray-300' : 'text-gray-500'} tracking-wide uppercase">${sender}</div>
          ${replyHtml}
          <div class="voice-message" data-voice-id="${messageId}">
            <div class="voice-play-btn" onclick='playVoiceNote("${messageId}", "${audioData}")'>‚ñ∂</div>
            <div class="voice-waveform">${barsHtml}</div>
            <div class="voice-duration">${durationText}</div>
          </div>
          <div id="reactions-${messageId}" class="reactions-container"></div>
        </div>
      `;
      
      chatDiv.appendChild(msgDiv);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    function displayChatMessage(sender, message, isMe, replyTo, messageId, isEdited) {
      const chatDiv = document.getElementById('chatMessages');
      
      // Check if message already exists (for edits)
      let msgDiv = messageId ? messageMap.get(messageId) : null;
      const isUpdate = !!msgDiv;
      
      if (!msgDiv) {
        msgDiv = document.createElement('div');
        msgDiv.className = 'chat-message';
        msgDiv.style.position = 'relative';
        if (messageId) {
          msgDiv.setAttribute('data-message-id', messageId);
          messageMap.set(messageId, msgDiv);
        }
      }
      
      const bubbleClass = isMe ? 'my-message' : 'other-message';
      
      let replyHtml = '';
      if (replyTo) {
        replyHtml = `
          <div class="reply-indicator">
            <div class="font-semibold">${escapeHtml(replyTo.username)}</div>
            <div class="truncate">${escapeHtml(replyTo.message.substring(0, 50))}${replyTo.message.length > 50 ? '...' : ''}</div>
          </div>
        `;
      }
      
      const editedHtml = isEdited ? '<div class="edited-indicator">edited</div>' : '';
      const editBtnHtml = isMe && messageId ? `<button class="edit-btn" data-message-id="${messageId}" data-message-text="${message.replace(/"/g, '&quot;')}" onclick='editMessage("${messageId}", this.dataset.messageText)'><span class="icon icon-edit"></span></button>` : '';
      const deleteBtnHtml = isMe && messageId ? `<button class="delete-btn" onclick='deleteMessage("${messageId}")'><span class="icon icon-delete"></span></button>` : '';
      
      let reactionPickerHtml = '';
      if (messageId) {
        reactionPickerHtml = `
          <div id="reaction-picker-${messageId}" class="reaction-picker">
            ${quickReactions.map(emoji => `<button class="reaction-option" onclick='addReaction("${messageId}", "${emoji}")'>${emoji}</button>`).join('')}
          </div>
          <button class="react-btn" onclick='toggleReactionPicker("${messageId}", event)'>üëç</button>
        `;
      }
      
      msgDiv.innerHTML = `
        <div class="${bubbleClass} rounded-2xl px-5 py-3 max-w-xs ${isMe ? 'ml-auto' : 'mr-auto'}" style="position: relative; padding-bottom: ${messageId ? '2rem' : '0.75rem'};">
          ${reactionPickerHtml}
          ${deleteBtnHtml}
          ${editBtnHtml}
          <button class="reply-btn" onclick='setReplyTo("${sender.replace(/"/g, '&quot;')}", "${escapeHtml(message).replace(/"/g, '&quot;').replace(/'/g, "&apos;")}")'><span class="icon icon-reply"></span></button>
          <div class="text-xs font-semibold mb-2 ${isMe ? 'text-gray-300' : 'text-gray-500'} tracking-wide uppercase">${sender}</div>
          ${replyHtml}
          <div class="text-sm text-white leading-relaxed font-light">${escapeHtml(message)}</div>
          ${editedHtml}
          <div id="reactions-${messageId}" class="reactions-container"></div>
        </div>
      `;
      
      if (!isUpdate) {
        chatDiv.appendChild(msgDiv);
        chatDiv.scrollTop = chatDiv.scrollHeight;
      }
      
      // Display reactions if they exist
      if (messageId && messageReactions.has(messageId)) {
        displayReactions(messageId, messageReactions.get(messageId));
      }
    }
    
    function displayMediaMessage(sender, message, mediaType, mediaData, isMe, replyTo, messageId) {
      const chatDiv = document.getElementById('chatMessages');
      
      const msgDiv = document.createElement('div');
      msgDiv.className = 'chat-message';
      msgDiv.style.position = 'relative';
      if (messageId) {
        msgDiv.setAttribute('data-message-id', messageId);
        messageMap.set(messageId, msgDiv);
      }
      
      const bubbleClass = isMe ? 'my-message' : 'other-message';
      
      let replyHtml = '';
      if (replyTo) {
        replyHtml = `
          <div class="reply-indicator">
            <div class="font-semibold">${escapeHtml(replyTo.username)}</div>
            <div class="truncate">${escapeHtml(replyTo.message.substring(0, 50))}${replyTo.message.length > 50 ? '...' : ''}</div>
          </div>
        `;
      }
      
      const deleteBtnHtml = isMe && messageId ? `<button class="delete-btn" onclick='deleteMessage("${messageId}")'><span class="icon icon-delete"></span></button>` : '';
      
      let reactionPickerHtml = '';
      if (messageId) {
        reactionPickerHtml = `
          <div id="reaction-picker-${messageId}" class="reaction-picker">
            ${quickReactions.map(emoji => `<button class="reaction-option" onclick='addReaction("${messageId}", "${emoji}")'>${emoji}</button>`).join('')}
          </div>
          <button class="react-btn" onclick='toggleReactionPicker("${messageId}", event)'>üëç</button>
        `;
      }
      
      let mediaHtml = '';
      if (mediaType === 'image') {
        mediaHtml = `<img src="${mediaData}" alt="Image" class="media-message">`;
      } else if (mediaType === 'video') {
        mediaHtml = `<video src="${mediaData}" controls class="media-message"></video>`;
      }
      
      const captionHtml = message ? `<div class="text-sm text-white leading-relaxed font-light mt-2">${escapeHtml(message)}</div>` : '';
      
      msgDiv.innerHTML = `
        <div class="${bubbleClass} rounded-2xl px-5 py-3 max-w-xs ${isMe ? 'ml-auto' : 'mr-auto'}" style="position: relative; padding-bottom: ${messageId ? '2rem' : '0.75rem'};">
          ${reactionPickerHtml}
          ${deleteBtnHtml}
          <button class="reply-btn" onclick='setReplyToMedia("${sender.replace(/"/g, '&quot;')}", "${mediaType}", "${messageId}")'><span class="icon icon-reply"></span></button>
          <div class="text-xs font-semibold mb-2 ${isMe ? 'text-gray-300' : 'text-gray-500'} tracking-wide uppercase">${sender}</div>
          ${replyHtml}
          ${mediaHtml}
          ${captionHtml}
          <div id="reactions-${messageId}" class="reactions-container"></div>
        </div>
      `;
      
      chatDiv.appendChild(msgDiv);
      chatDiv.scrollTop = chatDiv.scrollHeight;
      
      // Display reactions if they exist
      if (messageId && messageReactions.has(messageId)) {
        displayReactions(messageId, messageReactions.get(messageId));
      }
    }
    
    function setReplyToMedia(sender, mediaType, messageId) {
      const mediaText = mediaType === 'image' ? 'üì∑ Photo' : 'üé¨ Video';
      replyToMessage = { username: sender, message: mediaText, type: 'media', messageId };
      document.getElementById('replyToUser').textContent = sender;
      document.getElementById('replyBanner').classList.add('show');
      document.getElementById('chatInput').focus();
    }
    
    function updateCallParticipants(participants) {
      const participantsDiv = document.getElementById('participantsCount');
      if (participants && participants.length > 0) {
        participantsDiv.style.display = 'block';
        participantsDiv.textContent = `${participants.length} in call: ${participants.join(', ')}`;
      } else {
        participantsDiv.style.display = 'none';
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Resizable panels
    function initResizablePanels() {
      const leftPanel = document.getElementById('leftPanel');
      const rightPanel = document.getElementById('rightPanel');
      
      const leftHandle = leftPanel.querySelector('.resize-handle-right');
      const rightHandle = rightPanel.querySelector('.resize-handle-left');
      
      let isResizing = false;
      let currentPanel = null;
      
      function startResize(panel, e) {
        isResizing = true;
        currentPanel = panel;
        document.body.style.cursor = 'ew-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      }
      
      function resize(e) {
        if (!isResizing || !currentPanel) return;
        
        const rect = currentPanel.getBoundingClientRect();
        let newWidth;
        
        if (currentPanel === leftPanel) {
          newWidth = e.clientX - rect.left;
        } else {
          newWidth = rect.right - e.clientX;
        }
        
        const minWidth = parseInt(currentPanel.style.minWidth) || 250;
        const maxWidth = parseInt(currentPanel.style.maxWidth) || 500;
        
        newWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
        currentPanel.style.width = newWidth + 'px';
      }
      
      function stopResize() {
        isResizing = false;
        currentPanel = null;
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
      }
      
      leftHandle.addEventListener('mousedown', (e) => startResize(leftPanel, e));
      rightHandle.addEventListener('mousedown', (e) => startResize(rightPanel, e));
      
      document.addEventListener('mousemove', resize);
      document.addEventListener('mouseup', stopResize);
    }
    
    // Initialize resizable panels on load
    initResizablePanels();

    // Emoji Picker
    const emojis = [
      'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòÇ',
      'üôÇ', 'üôÉ', 'üòâ', 'üòä', 'üòá', 'ü•∞', 'üòç', 'ü§©',
      'üòò', 'üòó', 'üòö', 'üòô', 'üòã', 'üòõ', 'üòú', 'ü§™',
      'üòù', 'ü§ë', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î', 'ü§ê', 'ü§®',
      'üòê', 'üòë', 'üò∂', 'üòè', 'üòí', 'üôÑ', 'üò¨', 'ü§•',
      'üòå', 'üòî', 'üò™', 'ü§§', 'üò¥', 'üò∑', 'ü§í', 'ü§ï',
      'ü§¢', 'ü§Æ', 'ü§ß', 'ü•µ', 'ü•∂', 'üòµ', 'ü§Ø', 'ü§†',
      'ü•≥', 'üòé', 'ü§ì', 'üßê', 'üòï', 'üòü', 'üôÅ', 'üòÆ',
      'üòØ', 'üò≤', 'üò≥', 'ü•∫', 'üò¶', 'üòß', 'üò®', 'üò∞',
      'üò•', 'üò¢', 'üò≠', 'üò±', 'üòñ', 'üò£', 'üòû', 'üòì',
      'üò©', 'üò´', 'ü•±', 'üò§', 'üò°', 'üò†', 'ü§¨', 'üëç',
      'üëé', 'üëå', '‚úåÔ∏è', 'ü§û', 'ü§ü', 'ü§ò', 'ü§ô', 'üëà',
      'üëâ', 'üëÜ', 'üëá', '‚òùÔ∏è', 'üëã', 'ü§ö', 'üñêÔ∏è', '‚úã',
      'üññ', 'üëè', 'üôå', 'üëê', 'ü§≤', 'ü§ù', 'üôè', '‚úçÔ∏è',
      'üí™', 'ü¶æ', 'ü¶ø', 'ü¶µ', 'ü¶∂', 'üëÇ', 'ü¶ª', 'üëÉ',
      '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç',
      'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ',
      'üíò', 'üíù', 'üíü', '‚òÆÔ∏è', '‚úùÔ∏è', '‚ò™Ô∏è', 'üïâÔ∏è', '‚ò∏Ô∏è',
      '‚ú°Ô∏è', 'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê', '‚õé', '‚ôà',
      '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê',
      '‚ôë', '‚ôí', '‚ôì', 'üÜî', '‚öõÔ∏è', 'üâë', '‚ò¢Ô∏è', '‚ò£Ô∏è',
      'üî¥', 'üü†', 'üü°', 'üü¢', 'üîµ', 'üü£', '‚ö´', '‚ö™',
      'üü§', 'üî∫', 'üîª', 'üî∏', 'üîπ', 'üî∂', 'üî∑', 'üî≥',
      'üî≤', '‚ñ™Ô∏è', '‚ñ´Ô∏è', '‚óæ', '‚óΩ', '‚óºÔ∏è', '‚óªÔ∏è', 'üü•',
      'üüß', 'üü®', 'üü©', 'üü¶', 'üü™', '‚¨õ', '‚¨ú', 'üü´',
      '‚úÖ', '‚òëÔ∏è', '‚úîÔ∏è', '‚úñÔ∏è', '‚ùå', '‚ùé', '‚ûï', '‚ûñ',
      '‚ûó', '‚û∞', '‚ûø', '„ÄΩÔ∏è', '‚ú≥Ô∏è', '‚ú¥Ô∏è', '‚ùáÔ∏è', '‚ÄºÔ∏è',
      '‚ÅâÔ∏è', '‚ùì', '‚ùî', '‚ùï', '‚ùó', '„Ä∞Ô∏è', '¬©Ô∏è', '¬ÆÔ∏è',
      '‚Ñ¢Ô∏è', '#Ô∏è‚É£', '*Ô∏è‚É£', '0Ô∏è‚É£', '1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£',
      '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£', 'üîü', 'üî†', 'üî°',
      'üî¢', 'üî£', 'üî§', 'üÖ∞Ô∏è', 'üÜé', 'üÖ±Ô∏è', 'üÜë', 'üÜí',
      'üÜì', '‚ÑπÔ∏è', 'üÜî', '‚ìÇÔ∏è', 'üÜï', 'üÜñ', 'üÖæÔ∏è', 'üÜó',
      'üÖøÔ∏è', 'üÜò', 'üÜô', 'üÜö', 'üàÅ', 'üàÇÔ∏è', 'üà∑Ô∏è', 'üà∂',
      'üàØ', 'üâê', 'üàπ', 'üàö', 'üà≤', 'üâë', 'üà∏', 'üà¥',
      'üé¨', 'üé≠', 'üé®', 'üé™', 'üé§', 'üéß', 'üéº', 'üéπ',
      'ü•Å', 'üé∑', 'üé∫', 'üé∏', 'ü™ï', 'üéª', 'üé≤', '‚ôüÔ∏è',
      'üéØ', 'üé≥', 'üéÆ', 'üé∞', 'üß©', 'üöó', 'üöï', 'üöô',
      'üöå', 'üöé', 'üèéÔ∏è', 'üöì', 'üöë', 'üöí', 'üöê', 'üöö',
      'üöõ', 'üöú', 'ü¶Ø', 'ü¶Ω', 'ü¶º', 'üõ¥', 'üö≤', 'üõµ',
      'üèçÔ∏è', 'üõ∫', 'üö®', 'üöî', 'üöç', 'üöò', 'üöñ', 'üö°'
    ];

    function initEmojiPicker() {
      const emojiGrid = document.getElementById('emojiGrid');
      emojis.forEach(emoji => {
        const btn = document.createElement('button');
        btn.className = 'emoji-btn';
        btn.textContent = emoji;
        btn.onclick = () => insertEmoji(emoji);
        emojiGrid.appendChild(btn);
      });
    }

    function toggleEmojiPicker() {
      const picker = document.getElementById('emojiPicker');
      picker.classList.toggle('show');
    }

    function insertEmoji(emoji) {
      const input = document.getElementById('chatInput');
      const start = input.selectionStart;
      const end = input.selectionEnd;
      const text = input.value;
      
      input.value = text.substring(0, start) + emoji + text.substring(end);
      input.focus();
      
      const newPos = start + emoji.length;
      input.setSelectionRange(newPos, newPos);
      
      toggleEmojiPicker();
    }

    // Close emoji picker when clicking outside
    document.addEventListener('click', (e) => {
      const picker = document.getElementById('emojiPicker');
      const emojiBtn = e.target.closest('button[onclick="toggleEmojiPicker()"]');
      
      if (!picker.contains(e.target) && !emojiBtn && picker.classList.contains('show')) {
        picker.classList.remove('show');
      }
    });

    // Initialize emoji picker
    initEmojiPicker();
    
    // Emoji Reactions
    const quickReactions = ['‚ù§Ô∏è', 'üòÇ', 'üëç', 'üòÆ', 'üò¢', 'üôè'];
    
    function toggleReactionPicker(messageId, event) {
      event.stopPropagation();
      
      // Close existing picker if any
      if (activeReactionPicker) {
        activeReactionPicker.classList.remove('show');
      }
      
      const picker = document.getElementById(`reaction-picker-${messageId}`);
      if (picker.classList.contains('show')) {
        picker.classList.remove('show');
        activeReactionPicker = null;
      } else {
        picker.classList.add('show');
        activeReactionPicker = picker;
      }
    }
    
    function addReaction(messageId, emoji) {
      if (!ws || ws.readyState !== WebSocket.OPEN || !roomId) {
        return;
      }
      
      ws.send(JSON.stringify({
        roomId,
        action: 'reaction',
        messageId,
        emoji,
        username
      }));
      
      // Close picker
      const picker = document.getElementById(`reaction-picker-${messageId}`);
      if (picker) {
        picker.classList.remove('show');
        activeReactionPicker = null;
      }
    }
    
    function removeReaction(messageId, emoji) {
      if (!ws || ws.readyState !== WebSocket.OPEN || !roomId) {
        return;
      }
      
      ws.send(JSON.stringify({
        roomId,
        action: 'removeReaction',
        messageId,
        emoji,
        username
      }));
    }
    
    function displayReactions(messageId, reactions) {
      const container = document.getElementById(`reactions-${messageId}`);
      if (!container) return;
      
      if (!reactions || Object.keys(reactions).length === 0) {
        container.innerHTML = '';
        return;
      }
      
      let html = '';
      for (const [emoji, users] of Object.entries(reactions)) {
        const count = users.length;
        const hasMyReaction = users.includes(username);
        const bubbleClass = hasMyReaction ? 'reaction-bubble my-reaction' : 'reaction-bubble';
        const action = hasMyReaction ? `removeReaction('${messageId}', '${emoji}')` : `addReaction('${messageId}', '${emoji}')`;
        
        html += `
          <div class="${bubbleClass}" onclick="${action}" title="${users.join(', ')}">
            <span>${emoji}</span>
            <span class="reaction-count">${count}</span>
          </div>
        `;
      }
      
      container.innerHTML = html;
    }
    
    // Close reaction picker when clicking outside
    document.addEventListener('click', (e) => {
      if (activeReactionPicker && !e.target.closest('.reaction-picker') && !e.target.closest('.react-btn')) {
        activeReactionPicker.classList.remove('show');
        activeReactionPicker = null;
      }
    });
  </script>
</body>
</html>
